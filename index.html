<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­è©•ä¾¡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ | Teacher Support Pro</title>
    <style>
        :root {
            --primary: #e8f5e9;
            --accent: #81c784;
            --dark-green: #2e7d32;
            --bg: #f9fbf9;
            --white: #ffffff;
            --good: #c8e6c9;
            --bad: #ffccbc;
            --gray: #f0f0f0;
            --selected: #4caf50;
        }

        body {
            font-family: 'Helvetica Neue', Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--accent);
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0; z-index: 1001;
        }

        .current-time {
            font-size: 0.9rem;
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 15px;
        }

        main {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            width: 95%;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        h2, h3 { color: var(--dark-green); margin-top: 0; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: #666; }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 2px solid var(--primary);
            border-radius: 10px; font-size: 1rem; box-sizing: border-box;
            background: white;
        }

        .btn {
            background-color: var(--accent);
            color: white; border: none; padding: 12px 20px;
            border-radius: 25px; cursor: pointer;
            font-weight: bold; font-size: 1rem;
            transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }

        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--dark-green); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }

        .tabs {
            display: flex; gap: 10px; overflow-x: auto;
            margin-bottom: 20px; padding-bottom: 5px;
        }
        .tab {
            padding: 8px 16px; background: var(--white);
            border: 2px solid var(--primary); border-radius: 20px;
            cursor: pointer; white-space: nowrap; font-size: 0.9rem;
        }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        .seating-grid { display: grid; gap: 8px; margin-top: 15px; }
        .seat {
            aspect-ratio: 1.2 / 1; border: 1px solid var(--primary);
            border-radius: 6px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: white; cursor: pointer; font-size: 0.75rem; text-align: center;
            padding: 4px; overflow: hidden;
            position: relative;
            transition: background 0.2s;
        }
        .seat span { font-size: 0.6rem; color: #888; margin-top: 2px; }
        .seat.dragging { opacity: 0.5; background: var(--primary); }
        .seat.drag-over { border: 2px dashed var(--accent); background: #f1f8f1; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: var(--white); display: flex;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item {
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 0.7rem; color: #888; flex: 1;
        }
        .nav-item.active { color: var(--dark-green); font-weight: bold; }

        .ai-container { background: #f0fdf4; border: 2px solid var(--accent); border-radius: 15px; padding: 20px; margin: 15px 0; }
        .keyword-tag { display: inline-block; background: var(--white); border: 1px solid var(--accent); padding: 5px 12px; border-radius: 15px; margin: 4px; font-size: 0.8rem; cursor: pointer; }
        .keyword-tag.selected { background: var(--accent); color: white; }

        .hidden { display: none !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 25px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: #333; }
    </style>
</head>
<body>

<header>
    <div id="header-title">ãƒ›ãƒ¼ãƒ </div>
    <div class="current-time" id="digital-clock">00:00:00</div>
</header>

<main>
    <!-- Home -->
    <div id="view-home" class="page-view">
        <div class="card">
            <h2>æœ¬æ—¥ã®æˆæ¥­äºˆå®š</h2>
            <div id="home-today-date" style="margin-bottom: 12px; color: var(--dark-green); font-weight: bold;"></div>
            <div id="today-schedule-list"></div>
        </div>
        <div class="card">
            <h2>æ˜æ—¥ä»¥é™ã®äºˆå®š</h2>
            <div id="future-schedule-list"></div>
        </div>
    </div>

    <!-- List (Lesson Plans) -->
    <div id="view-list" class="page-view hidden">
        <div class="tabs" id="list-class-tabs"></div>
        <div class="card">
            <h2 id="list-title">ã™ã¹ã¦ã®æˆæ¥­è¨ˆç”»</h2>
            <div id="all-plans-list"></div>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="prepareNewPlan()">ï¼‹ æ–°è¦æˆæ¥­è¨ˆç”»ã‚’ä½œæˆ</button>
        </div>
    </div>

    <!-- Plan Edit -->
    <div id="view-plan" class="page-view hidden">
        <div class="card">
            <h2 id="plan-form-title">æˆæ¥­ã®ç™»éŒ²ãƒ»ç·¨é›†</h2>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;"><label>æ—¥ä»˜</label><input type="date" id="plan-date"></div>
                <div style="flex: 1;"><label>æ ¡æ™‚</label><select id="plan-period"></select></div>
            </div>
            <label>ã‚¯ãƒ©ã‚¹é¸æŠ</label>
            <select id="plan-class-select"></select>

            <label>è©•ä¾¡åŸºæº–ï¼ˆæ•™ç§‘æ›¸ã®ç›®æ¨™ãªã©ï¼‰</label>
            <textarea id="raw-criteria" placeholder="æ•™ç§‘æ›¸ã®ç›®æ¨™ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            <button class="btn" id="ai-gen-btn" onclick="processAI()">AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ</button>

            <div id="ai-section" class="ai-container hidden">
                <h3>AIæŠ½å‡ºãƒã‚¤ãƒ³ãƒˆ</h3>
                <div id="ai-output" style="font-weight: bold; margin-bottom: 10px; white-space: pre-wrap;"></div>
                <div id="ai-keywords"></div>
                <label>è¿½åŠ è¦æœ›</label>
                <input type="text" id="teacher-plus" placeholder="ã‚‚ã£ã¨å…·ä½“çš„ã«ã€ãªã©">
                <button class="btn btn-outline" style="width: 100%;" onclick="processAI(true)">å†æ§‹æˆã™ã‚‹</button>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" style="flex: 2;" onclick="savePlan()">ä¿å­˜</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="switchView('list')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- Class List (Seating Management) -->
    <div id="view-seating-list" class="page-view hidden">
        <div class="card">
            <h2>ã‚¯ãƒ©ã‚¹ãƒ»åº§å¸­è¡¨ç®¡ç†</h2>
            <div id="saved-classes-list"></div>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="prepareNewClass()">ï¼‹ æ–°è¦ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ</button>
        </div>
    </div>

    <!-- Seating Edit -->
    <div id="view-seating-edit" class="page-view hidden">
        <div class="card">
            <h2 id="seating-title">åº§å¸­è¡¨ã®è¨­å®š</h2>
            <input type="text" id="cls-name" placeholder="ä¾‹: ä¸­1A">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div><label>è¡Œ</label><input type="number" id="cls-rows" value="6" oninput="updatePreview()"></div>
                <div><label>åˆ—</label><input type="number" id="cls-cols" value="6" oninput="updatePreview()"></div>
                <div><label>åˆè¨ˆ</label><input type="text" id="cls-sum" readonly style="background:#f0f0f0"></div>
            </div>
            <label>ç”Ÿå¾’åç°¿ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼‰</label>
            <textarea id="cls-students" placeholder="åå‰ã‚’1è¡Œãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„" oninput="updatePreview()"></textarea>

            <div id="preview-area" class="hidden">
                <h3 style="margin-top: 15px;">åº§å¸­ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">â€» åå‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
                <div id="preview-grid" class="seating-grid"></div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" style="flex: 2;" onclick="saveClass()">ã‚¯ãƒ©ã‚¹æƒ…å ±ã‚’ä¿å­˜</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="switchView('seating-list')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="view-settings" class="page-view hidden">
        <div class="card">
            <h2>å„ç¨®è¨­å®š</h2>
            <h3>æ ¡æ™‚è¨­å®š</h3>
            <div id="period-editor"></div>
            <button class="btn btn-outline" onclick="addEntry('periods')">ï¼‹ è¿½åŠ </button>
            <h3 style="margin-top:20px">è©•ä¾¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="action-editor"></div>
            <button class="btn btn-outline" onclick="addEntry('actions')">ï¼‹ è¿½åŠ </button>
        </div>
        <div class="card">
            <h2>ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>
            <button class="btn" onclick="downloadCSV()">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <!-- Run -->
    <div id="view-lesson-run" class="page-view hidden">
        <div class="card" id="run-header-info"></div>
        <div id="run-grid" class="seating-grid"></div>
        <button class="btn btn-outline" style="margin-top: 20px;" onclick="switchView('home')">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
    </div>
</main>

<nav class="bottom-nav">
    <div class="nav-item" onclick="switchView('home')"><span>ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></div>
    <div class="nav-item" onclick="switchView('list')"><span>ğŸ“</span><span>æˆæ¥­è¨ˆç”»</span></div>
    <div class="nav-item" onclick="switchView('seating-list')"><span>ğŸª‘</span><span>åº§å¸­è¡¨</span></div>
    <div class="nav-item" onclick="switchView('settings')"><span>âš™ï¸</span><span>è¨­å®š</span></div>
</nav>

<div id="eval-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h2 id="eval-st-name"></h2>
        <div id="eval-target" style="padding: 10px; background: var(--primary); border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;"></div>
        <div class="action-grid" id="eval-btns"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    const apiKey = "";
    let appState = {
        periods: [{id:1, name:"1é™", start:"08:50"}, {id:2, name:"2é™", start:"09:50"}, {id:3, name:"3é™", start:"10:50"}],
        classes: [{id:"c1", name:"ä¸­1A", rows:6, cols:6, students: ["ç”°ä¸­", "ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ä¼Šè—¤", "æ¸¡è¾º"]}],
        plans: [],
        actions: [{id:1, text:"ç™ºè¨€", type:"good"}, {id:2, text:"æ•™ãˆåˆã„", type:"good"}, {id:3, text:"é›†ä¸­æ¬ å¦‚", type:"bad"}],
        evaluations: [],
        editingPlanId: null,
        editingClassId: null,
        selectedKeywords: [],
        activeListTab: "ã™ã¹ã¦"
    };

    // --- Persistence ---
    function load() {
        const d = localStorage.getItem('teacher_pro_v5');
        if(d) appState = JSON.parse(d);
        updateClock();
        setInterval(updateClock, 1000);
        switchView('home');
    }
    function save() { localStorage.setItem('teacher_pro_v5', JSON.stringify(appState)); }

    function updateClock() {
        const now = new Date();
        const el = document.getElementById('digital-clock');
        if(el) el.innerText = now.toLocaleTimeString('ja-JP');
    }

    function switchView(id) {
        document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${id}`).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navMap = {home:0, list:1, 'seating-list':2, settings:3};
        if(navMap[id] !== undefined) document.querySelectorAll('.nav-item')[navMap[id]].classList.add('active');

        const titleMap = {
            home:'ãƒ›ãƒ¼ãƒ ', list:'æˆæ¥­è¨ˆç”»ä¸€è¦§', plan:'æˆæ¥­è¨ˆç”»ç·¨é›†', 
            'seating-list':'ã‚¯ãƒ©ã‚¹ä¸€è¦§', 'seating-edit':'åº§å¸­è¡¨ç·¨é›†', 
            settings:'è¨­å®š', 'lesson-run':'å®Ÿæ–½ä¸­'
        };
        document.getElementById('header-title').innerText = titleMap[id] || 'Teacher Support';

        if(id === 'home') renderHome();
        if(id === 'list') renderPlanTabs();
        if(id === 'plan') renderPlanForm(); // é¸æŠè‚¢ã‚’æœ€æ–°ã«æ›´æ–°
        if(id === 'seating-list') renderClassList();
        if(id === 'settings') renderSettings();
    }

    // --- Plan Form Select Logic (FIXED) ---
    function renderPlanForm() {
        const periodSelect = document.getElementById('plan-period');
        const classSelect = document.getElementById('plan-class-select');

        // æ ¡æ™‚ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
        periodSelect.innerHTML = appState.periods.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        
        // ã‚¯ãƒ©ã‚¹ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
        if(appState.classes.length === 0) {
            classSelect.innerHTML = `<option value="">â€» ã‚¯ãƒ©ã‚¹ã‚’å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„</option>`;
        } else {
            classSelect.innerHTML = appState.classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        // ç·¨é›†ä¸­ã®å ´åˆã¯å€¤ã‚’å¾©å…ƒ
        if(appState.editingPlanId) {
            const p = appState.plans.find(x => x.id === appState.editingPlanId);
            if(p) {
                document.getElementById('plan-date').value = p.date;
                periodSelect.value = p.period;
                classSelect.value = p.className;
            }
        }
    }

    // --- Seating Logic ---
    function updatePreview() {
        const r = parseInt(document.getElementById('cls-rows').value) || 0;
        const c = parseInt(document.getElementById('cls-cols').value) || 0;
        const namesStr = document.getElementById('cls-students').value;
        const names = namesStr.split('\n').map(n => n.trim());
        document.getElementById('cls-sum').value = r * c;

        const area = document.getElementById('preview-area');
        const grid = document.getElementById('preview-grid');
        
        if(r > 0 && c > 0) {
            area.classList.remove('hidden');
            grid.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
            grid.innerHTML = "";

            for(let i=0; i < r*c; i++) {
                const seat = document.createElement('div');
                seat.className = 'seat';
                seat.draggable = true;
                seat.dataset.index = i;
                
                const name = names[i] || '';
                seat.innerHTML = `<b>${name || '-'}</b><span>${i+1}</span>`;

                seat.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', i);
                    seat.classList.add('dragging');
                };
                seat.ondragend = () => seat.classList.remove('dragging');
                seat.ondragover = (e) => { e.preventDefault(); seat.classList.add('drag-over'); };
                seat.ondragleave = () => seat.classList.remove('drag-over');
                seat.ondrop = (e) => {
                    e.preventDefault();
                    seat.classList.remove('drag-over');
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    swapStudents(fromIndex, i);
                };
                grid.appendChild(seat);
            }
        }
    }

    function swapStudents(from, to) {
        const students = document.getElementById('cls-students').value.split('\n');
        const r = parseInt(document.getElementById('cls-rows').value);
        const c = parseInt(document.getElementById('cls-cols').value);
        const total = r * c;
        while(students.length < total) students.push("");
        
        const temp = students[from];
        students[from] = students[to];
        students[to] = temp;
        
        document.getElementById('cls-students').value = students.join('\n');
        updatePreview();
    }

    function prepareNewClass() {
        appState.editingClassId = null;
        document.getElementById('seating-title').innerText = "æ–°è¦ã‚¯ãƒ©ã‚¹ä½œæˆ";
        document.getElementById('cls-name').value = "";
        document.getElementById('cls-rows').value = 6;
        document.getElementById('cls-cols').value = 6;
        document.getElementById('cls-students').value = "";
        updatePreview();
        switchView('seating-edit');
    }

    function saveClass() {
        const name = document.getElementById('cls-name').value;
        const r = parseInt(document.getElementById('cls-rows').value);
        const c = parseInt(document.getElementById('cls-cols').value);
        const names = document.getElementById('cls-students').value.split('\n').map(n => n.trim());
        if(!name || !r || !c) return alert("å¿…é ˆé …ç›®ã‚’åŸ‹ã‚ã¦ãã ã•ã„");

        const data = { id: appState.editingClassId || 'c'+Date.now(), name, rows: r, cols: c, students: names };
        if(appState.editingClassId) appState.classes = appState.classes.map(x => x.id === data.id ? data : x);
        else appState.classes.push(data);

        appState.editingClassId = null;
        save(); switchView('seating-list');
    }

    function renderClassList() {
        const list = document.getElementById('saved-classes-list');
        if(appState.classes.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#999;'>ç™»éŒ²ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            return;
        }
        list.innerHTML = appState.classes.map(c => `
            <div class="card" style="padding:15px; margin-bottom:10px; border-left:5px solid var(--accent)">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b>${c.name}</b>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-outline" onclick="editClass('${c.id}')">ç·¨é›†</button>
                        <button class="btn-outline" style="color:red; border-color:red" onclick="deleteClass('${c.id}')">å‰Šé™¤</button>
                    </div>
                </div>
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">${c.rows}Ã—${c.cols} / ç™»éŒ²äººæ•°: ${c.students.filter(s=>s).length}å</div>
            </div>
        `).join('');
    }

    function editClass(id) {
        const c = appState.classes.find(x => x.id === id);
        appState.editingClassId = id;
        document.getElementById('seating-title').innerText = "ã‚¯ãƒ©ã‚¹æƒ…å ±ã®ç·¨é›†";
        document.getElementById('cls-name').value = c.name;
        document.getElementById('cls-rows').value = c.rows;
        document.getElementById('cls-cols').value = c.cols;
        document.getElementById('cls-students').value = c.students.join('\n');
        updatePreview();
        switchView('seating-edit');
    }

    function deleteClass(id) {
        if(confirm("ã“ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            appState.classes = appState.classes.filter(x => x.id !== id);
            save(); renderClassList();
        }
    }

    // --- AI Logic ---
    async function processAI(isRedo = false) {
        const raw = document.getElementById('raw-criteria').value;
        const plus = document.getElementById('teacher-plus').value;
        const btn = document.getElementById('ai-gen-btn');
        if(!raw) return alert("åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        btn.innerText = "ç”Ÿæˆä¸­..."; btn.disabled = true;

        const sys = `æ•™å“¡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚è©•ä¾¡åŸºæº–ã‹ã‚‰ã€Œãƒ»ã€œã—ã¦ã„ã‚‹ã€å½¢å¼ã§è¦³å¯Ÿé …ç›®ã‚’3ã¤æŠ½å‡ºã€‚å„20å­—ä»¥å†…ã€‚`;
        let user = `åŸºæº–: ${raw}`;
        if(isRedo) user += `\næ³¨ç›®èª: ${appState.selectedKeywords.join(',')}\nè¦æœ›: ${plus}`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ contents:[{parts:[{text:user}]}], systemInstruction:{parts:[{text:sys}]} })
            });
            const d = await res.json();
            const text = d.candidates?.[0]?.content?.parts?.[0]?.text || "ãƒ»ãƒã‚¤ãƒ³ãƒˆ1\nãƒ»ãƒã‚¤ãƒ³ãƒˆ2\nãƒ»ãƒã‚¤ãƒ³ãƒˆ3";
            document.getElementById('ai-output').innerText = text.trim();
            if(!isRedo) {
                const kws = [...new Set(raw.match(/[ä¸€-é¾ ]{2,}/g) || ["æ€è€ƒ","åˆ¤æ–­"])].slice(0,6);
                document.getElementById('ai-keywords').innerHTML = kws.map(k => `<span class="keyword-tag" onclick="this.classList.toggle('selected'); toggleKw('${k}')">${k}</span>`).join('');
            }
            document.getElementById('ai-section').classList.remove('hidden');
        } catch(e) { alert("AIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"); }
        finally { btn.innerText="AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆç”Ÿæˆ"; btn.disabled=false; }
    }

    function toggleKw(k) {
        if(appState.selectedKeywords.includes(k)) appState.selectedKeywords = appState.selectedKeywords.filter(x => x!==k);
        else appState.selectedKeywords.push(k);
    }

    function prepareNewPlan() {
        appState.editingPlanId = null;
        appState.selectedKeywords = [];
        document.getElementById('plan-form-title').innerText = "æ–°è¦æˆæ¥­è¨ˆç”»ã®ä½œæˆ";
        document.getElementById('plan-date').valueAsDate = new Date();
        document.getElementById('raw-criteria').value = "";
        document.getElementById('ai-output').innerText = "";
        document.getElementById('ai-section').classList.add('hidden');
        document.getElementById('teacher-plus').value = "";
        switchView('plan');
    }

    function savePlan() {
        const d = document.getElementById('plan-date').value;
        const p = document.getElementById('plan-period').value;
        const c = document.getElementById('plan-class-select').value;
        const ai = document.getElementById('ai-output').innerText;
        
        if(!d || !ai || !c) return alert("å¿…é ˆé …ç›®ï¼ˆæ—¥ä»˜ã€ã‚¯ãƒ©ã‚¹ã€AIç”Ÿæˆå†…å®¹ï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");

        const plan = { 
            id: appState.editingPlanId || Date.now(), 
            date: d, 
            period: p, 
            className: c, 
            raw: document.getElementById('raw-criteria').value,
            aiPoints: ai.split('\n').map(x => x.trim()).filter(x => x) 
        };
        
        if(appState.editingPlanId) appState.plans = appState.plans.map(x => x.id === plan.id ? plan : x);
        else appState.plans.push(plan);
        
        appState.editingPlanId = null;
        save(); 
        switchView('list');
    }

    function renderPlanTabs() {
        const clsNames = ["ã™ã¹ã¦", ...new Set(appState.classes.map(c => c.name))];
        const tabContainer = document.getElementById('list-class-tabs');
        tabContainer.innerHTML = clsNames.map(n => `
            <div class="tab ${appState.activeListTab === n ? 'active' : ''}" onclick="appState.activeListTab='${n}'; renderPlanTabs(); renderAllPlansList();">${n}</div>
        `).join('');
        renderAllPlansList();
    }

    function renderAllPlansList() {
        let filtered = appState.plans;
        if(appState.activeListTab !== "ã™ã¹ã¦") {
            filtered = filtered.filter(p => p.className === appState.activeListTab);
        }
        filtered.sort((a,b) => b.date.localeCompare(a.date));
        const list = document.getElementById('all-plans-list');
        if(filtered.length === 0) {
            list.innerHTML = "<p style='color:#999; text-align:center; padding:20px;'>è¡¨ç¤ºã§ãã‚‹æˆæ¥­è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            return;
        }
        list.innerHTML = filtered.map(p => `
            <div class="card" style="padding:15px; border-left:5px solid var(--accent); margin-bottom:10px">
                <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                    <div>
                        <b>${p.date} / ${p.period} / ${p.className}</b>
                        <div style="font-size:0.8rem; margin-top:5px; color:#666">${p.aiPoints.join(' / ')}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-outline" onclick="editPlan(${p.id})">ç·¨é›†</button>
                        <button class="btn-outline" style="color:red; border-color:red;" onclick="deletePlan(${p.id})">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function editPlan(id) {
        appState.editingPlanId = id;
        switchView('plan');
        const p = appState.plans.find(x => x.id === id);
        if(p) {
            document.getElementById('plan-form-title').innerText = "æˆæ¥­è¨ˆç”»ã®ä¿®æ­£";
            document.getElementById('raw-criteria').value = p.raw || "";
            document.getElementById('ai-output').innerText = p.aiPoints.join('\n');
            document.getElementById('ai-section').classList.remove('hidden');
        }
    }

    function deletePlan(id) {
        if(confirm("ã“ã®æˆæ¥­è¨ˆç”»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            appState.plans = appState.plans.filter(x => x.id !== id);
            save(); renderAllPlansList();
        }
    }

    // --- Home Display ---
    function renderHome() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        document.getElementById('home-today-date').innerText = now.toLocaleDateString('ja-JP', {month:'long', day:'numeric', weekday:'long'});
        
        const todayPlans = appState.plans.filter(p => p.date === today).sort((a,b) => a.period.localeCompare(b.period));
        const futurePlans = appState.plans.filter(p => p.date > today).sort((a,b) => a.date.localeCompare(b.date) || a.period.localeCompare(b.period));

        const draw = (ps, elId) => {
            const el = document.getElementById(elId);
            if(ps.length === 0) return el.innerHTML = "<p style='color:#999; text-align:center;'>äºˆå®šãªã—</p>";
            el.innerHTML = ps.map(p => `
                <div class="card" onclick="startRun(${p.id})" style="border-left:8px solid var(--accent); cursor:pointer; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b>${p.period} : ${p.className}</b>
                        <span style="color:var(--accent); font-size:0.8rem;">è©•ä¾¡é–‹å§‹ ï¼</span>
                    </div>
                    <div style="font-size:0.8rem; margin-top:5px; color:#777;">${p.aiPoints[0]}...</div>
                </div>
            `).join('');
        };
        draw(todayPlans, 'today-schedule-list');
        draw(futurePlans, 'future-schedule-list');
    }

    // --- Run Logic ---
    let currentRun = null;
    function startRun(id) {
        currentRun = appState.plans.find(x => x.id === id);
        const cls = appState.classes.find(c => c.name === currentRun.className);
        if(!cls) return alert("å¯¾å¿œã™ã‚‹ã‚¯ãƒ©ã‚¹ã®åº§å¸­è¡¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åº§å¸­è¡¨ã‚¿ãƒ–ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚");
        
        switchView('lesson-run');
        document.getElementById('run-header-info').innerHTML = `
            <h3>${currentRun.className} - ${currentRun.period}</h3>
            <div style="font-size:0.9rem; color:#555; background:var(--primary); padding:10px; border-radius:10px;">
                ${currentRun.aiPoints.map(pt => `<div>${pt}</div>`).join('')}
            </div>
        `;
        const grid = document.getElementById('run-grid');
        grid.style.gridTemplateColumns = `repeat(${cls.cols}, 1fr)`;
        grid.innerHTML = Array.from({length: cls.rows * cls.cols}).map((_, i) => {
            const name = cls.students[i] || '';
            return `
                <div class="seat" onclick="openEval(${i+1}, '${name || 'ç•ªå·'+(i+1)}')">
                    <b>${name || '-'}</b>
                    <span>${i+1}</span>
                </div>
            `;
        }).join('');
    }

    let targetIdx = null;
    function openEval(idx, name) {
        targetIdx = idx;
        document.getElementById('eval-st-name').innerText = name;
        document.getElementById('eval-target').innerText = "é‡ç‚¹: " + (currentRun.aiPoints[0] || "æœªè¨­å®š");
        document.getElementById('eval-btns').innerHTML = appState.actions.map(a => `
            <button class="action-btn" style="background:${a.type==='good'?'var(--good)':'var(--bad)'}" onclick="record('${a.text}')">${a.text}</button>
        `).join('');
        document.getElementById('eval-modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('eval-modal-overlay').style.display = 'none'; }
    function record(act) {
        appState.evaluations.push({ 
            time: new Date().toLocaleString('ja-JP'), 
            d: currentRun.date, 
            p: currentRun.period, 
            c: currentRun.className, 
            s: targetIdx, 
            a: act 
        });
        save(); 
        closeModal();
    }

    // --- CSV & Settings ---
    function downloadCSV() {
        if(appState.evaluations.length === 0) return alert("è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“");
        let csv = "\uFEFFæ—¥ä»˜,æ ¡æ™‚,ã‚¯ãƒ©ã‚¹,ç”Ÿå¾’(ç•ªå·),è¨˜éŒ²æ™‚åˆ»,å†…å®¹\n";
        const sorted = [...appState.evaluations].sort((a,b) => a.d.localeCompare(b.d) || a.p.localeCompare(b.p));
        sorted.forEach(e => {
            csv += `"${e.d}","${e.p}","${e.c}","${e.s}","${e.time}","${e.a}"\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `è©•ä¾¡è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.csv`; 
        a.click();
    }

    function renderSettings() {
        const pe = document.getElementById('period-editor');
        pe.innerHTML = appState.periods.map((p,i) => `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input type="text" value="${p.name}" onchange="appState.periods[${i}].name=this.value;save()">
                <input type="time" value="${p.start}" onchange="appState.periods[${i}].start=this.value;save()">
                <button onclick="appState.periods.splice(${i},1);save();renderSettings()">âœ•</button>
            </div>`).join('');
        const ae = document.getElementById('action-editor');
        ae.innerHTML = appState.actions.map((a,i) => `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input type="text" value="${a.text}" onchange="appState.actions[${i}].text=this.value;save()">
                <select onchange="appState.actions[${i}].type=this.value;save()">
                    <option value="good" ${a.type==='good'?'selected':''}>è‰¯</option>
                    <option value="bad" ${a.type==='bad'?'selected':''}>ä¸</option>
                </select>
                <button onclick="appState.actions.splice(${i},1);save();renderSettings()">âœ•</button>
            </div>`).join('');
    }
    
    function addEntry(k) {
        if(k==='periods') appState.periods.push({id:Date.now(), name:"æ–°æ ¡æ™‚", start:"00:00"});
        if(k==='actions') appState.actions.push({id:Date.now(), text:"æ–°è¡Œå‹•", type:"good"});
        save(); 
        renderSettings();
    }

    window.onload = load;
</script>
</body>
</html>
