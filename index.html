<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI-Board Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');
        
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: #fff9f9; 
            color: #4a4a4a;
            padding-bottom: 120px; 
        }
        
        .rounded-3xl { border-radius: 2rem; }
        .soft-shadow { box-shadow: 0 10px 40px rgba(0,0,0,0.03); }
        
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid #ffe4e6;
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-radius: 2.5rem;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(251, 113, 133, 0.15);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            color: #a1a1aa;
            transition: all 0.3s ease;
            flex: 1;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .nav-item.active { color: #fb7185; }
        .nav-icon { width: 26px; height: 26px; margin-bottom: 2px; }

        .hidden { display: none !important; }
        button { transition: transform 0.2s, opacity 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        
        .seat {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 1rem;
            border: 2px solid #f3f4f6;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .seat:hover { border-color: #fb7185; transform: translateY(-2px); }

        .container-wide {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body>

    <div id="app" class="container-wide min-h-screen relative px-6 pt-8">
        
        <!-- HEADER -->
        <header class="mb-8 flex justify-between items-center bg-white p-6 rounded-3xl soft-shadow">
            <div>
                <h1 id="page-title" class="text-2xl font-bold text-rose-500">ホーム</h1>
                <p class="text-xs text-gray-400 mt-1">今日も一日、素敵な授業になりますように</p>
            </div>
            <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-500 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
        </header>

        <!-- VIEWS -->
        <main class="pb-24">
            <!-- HOME VIEW -->
            <section id="view-home" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <p class="text-sm font-bold text-rose-400 mb-4 ml-2">本日の予定</p>
                    <div id="today-schedule" class="space-y-4"></div>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-400 mb-4 ml-2">授業ライブラリ</p>
                    <div id="other-schedule" class="grid grid-cols-1 gap-3"></div>
                </div>
            </section>

            <!-- PLANNING VIEW -->
            <section id="view-plan" class="hidden">
                <div class="bg-white p-8 rounded-[2.5rem] soft-shadow border border-rose-50 space-y-6">
                    <input type="hidden" id="edit-plan-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                            <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">授業タイトル</label>
                            <input type="text" id="plan-subject" placeholder="例：1年A組 数学「連立方程式」" class="w-full bg-gray-50 p-4 rounded-2xl border-none focus:ring-2 focus:ring-rose-200 text-lg">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">日付</label>
                            <input type="date" id="plan-date" class="w-full bg-gray-50 p-4 rounded-2xl border-none text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">時間目</label>
                            <select id="plan-period" class="w-full bg-gray-50 p-4 rounded-2xl border-none text-sm"></select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">使用する座席表（クラス）</label>
                            <select id="plan-class-id" class="w-full bg-gray-50 p-4 rounded-2xl border-none text-sm">
                                <option value="">クラスを選択してください</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">① 評価基準・指導案のコピー（大きめの枠）</label>
                        <textarea id="plan-raw-criteria" rows="10" class="w-full bg-gray-50 p-6 rounded-3xl border-none text-sm leading-relaxed" placeholder="教科書の評価規準や、指導案の内容をそのまま貼り付けてください..."></textarea>
                    </div>

                    <div>
                        <label class="text-sm font-bold text-gray-400 ml-2 mb-2 block">② 先生の注目ポイント（自由入力）</label>
                        <input type="text" id="plan-focus-point" class="w-full bg-indigo-50 p-4 rounded-2xl border-none text-sm" placeholder="例：特にノートの記述の丁寧さに注目したい">
                    </div>

                    <div id="ai-insight-box" class="p-6 bg-gradient-to-br from-indigo-50 to-rose-50 rounded-[2rem] border border-white hidden">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-xs font-bold text-indigo-500 uppercase tracking-widest flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM5.884 6.607a1 1 0 01-.226 1.396l-1 1a1 1 0 01-1.396-1.414l1-1a1 1 0 011.622.018zM15 10a1 1 0 00-1-1h-1a1 1 0 100 2h1a1 1 0 001-1zM5.884 13.393a1 1 0 00-1.396-1.396l-1 1a1 1 0 001.414 1.414l1-1zM10 16a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM15.512 15.512a1 1 0 01-1.396 0l-1-1a1 1 0 011.396-1.396l1 1a1 1 0 010 1.396zM13 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                AI観察ポイント
                            </p>
                            <button onclick="showAIAssistant()" class="text-xs text-indigo-600 font-bold underline">再生成</button>
                        </div>
                        <ul id="ai-criteria-list" class="space-y-3"></ul>
                    </div>

                    <div class="pt-4 flex flex-col md:flex-row gap-4">
                        <button onclick="generateAICriteria()" id="btn-ai-generate" class="flex-1 py-5 bg-indigo-100 text-indigo-600 rounded-[2rem] font-bold text-lg hover:bg-indigo-200">
                            AIで観察ポイントを抽出
                        </button>
                        <button onclick="savePlan()" class="flex-1 py-5 bg-rose-500 text-white rounded-[2rem] font-bold text-lg shadow-xl shadow-rose-200">
                            この授業を保存する
                        </button>
                    </div>
                </div>
            </section>

            <!-- SEATING CONFIG VIEW -->
            <section id="view-seating-config" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-8 rounded-[2.5rem] soft-shadow space-y-4">
                        <h2 class="text-lg font-bold text-blue-500 mb-4">新規座席表の作成</h2>
                        <div>
                            <label class="text-xs font-bold text-gray-400 ml-2">クラス名</label>
                            <input type="text" id="class-name" class="w-full bg-gray-50 p-4 rounded-2xl border-none" placeholder="1年1組 など">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div><label class="text-[10px] font-bold text-center block mb-1">列</label><input type="number" id="seat-cols" value="6" onchange="updateSeatPreview()" class="w-full bg-gray-50 p-2 rounded-xl border-none text-center"></div>
                            <div><label class="text-[10px] font-bold text-center block mb-1">行</label><input type="number" id="seat-rows" value="5" onchange="updateSeatPreview()" class="w-full bg-gray-50 p-2 rounded-xl border-none text-center"></div>
                            <div><label class="text-[10px] font-bold text-center block mb-1">人数</label><input type="number" id="seat-count" value="30" onchange="updateSeatPreview()" class="w-full bg-gray-50 p-2 rounded-xl border-none text-center"></div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 ml-2">名簿（改行区切り）</label>
                            <textarea id="student-list" rows="10" oninput="updateSeatPreview()" class="w-full bg-gray-50 p-4 rounded-2xl border-none text-xs" placeholder="生徒名を一人一行で入力..."></textarea>
                        </div>
                        <button onclick="saveClassSeating()" class="w-full py-4 bg-blue-500 text-white rounded-2xl font-bold shadow-lg shadow-blue-100">座席表を保存</button>
                    </div>
                    
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-8 rounded-[2.5rem] soft-shadow min-h-[400px]">
                            <h3 class="text-center text-xs font-bold text-gray-300 uppercase tracking-widest mb-6">配置プレビュー</h3>
                            <div id="seating-preview" class="grid gap-2"></div>
                        </div>
                        <div id="saved-classes" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </section>

            <!-- ASSESSMENT VIEW -->
            <section id="view-assessment" class="hidden">
                <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
                    <div class="xl:col-span-3">
                        <div id="assess-remind" class="p-6 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-3xl border border-amber-100 mb-8 flex items-center gap-4">
                            <div class="p-3 bg-white rounded-2xl text-amber-500 shadow-sm">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <p id="assess-ai-points" class="text-sm text-amber-900 leading-relaxed font-bold"></p>
                        </div>
                        <div id="assess-seating-grid" class="grid gap-3 mb-12"></div>
                    </div>
                    
                    <div class="xl:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-[2.5rem] soft-shadow border border-gray-100 sticky top-4">
                            <h3 class="text-sm font-bold mb-4 flex items-center gap-2">
                                <span class="w-3 h-3 bg-rose-400 rounded-full animate-pulse"></span> リアルタイム評価ログ
                            </h3>
                            <div id="live-logs" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 text-sm text-gray-500"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SETTINGS VIEW -->
            <section id="view-settings" class="hidden max-w-2xl mx-auto">
                <div class="bg-white p-10 rounded-[2.5rem] soft-shadow space-y-8">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-700">時間割の設定</h3>
                        <button onclick="addPeriodSlot()" class="px-4 py-2 bg-rose-50 text-rose-500 rounded-xl text-xs font-bold">+ 時間枠を追加</button>
                    </div>
                    <div id="period-settings" class="space-y-4"></div>
                    <button onclick="saveSettings()" class="w-full py-5 bg-gray-800 text-white rounded-2xl font-bold">設定内容を保存</button>
                </div>
            </section>
        </main>

        <!-- NAVIGATION -->
        <nav class="bottom-nav">
            <button onclick="switchTab('home')" class="nav-item active" id="btn-nav-home">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span>ホーム</span>
            </button>
            <button onclick="switchTab('plan')" class="nav-item" id="btn-nav-plan">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <span>計画</span>
            </button>
            <button onclick="switchTab('seating-config')" class="nav-item" id="btn-nav-seating-config">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                <span>座席表</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-item" id="btn-nav-settings">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>設定</span>
            </button>
        </nav>

        <!-- AI ASISTANT MODAL -->
        <div id="ai-modal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-6 z-[200]">
            <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-lg shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl">AI構成アシスタント</h3>
                    <button onclick="closeAIModal()" class="text-gray-300 hover:text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="keyword-chips" class="flex flex-wrap gap-2 mb-6 p-4 bg-gray-50 rounded-2xl min-h-[100px]"></div>
                <label class="text-xs font-bold text-gray-500 mb-2 block">追加の指示</label>
                <input type="text" id="ai-custom-prompt" placeholder="例：ICTの活用状況を重点的に" class="w-full bg-gray-50 p-4 rounded-xl border-none mb-6">
                <button onclick="executeAIRebuild()" class="w-full py-4 bg-indigo-500 text-white rounded-2xl font-bold shadow-xl flex items-center justify-center gap-2">
                    目安を再生成する
                </button>
            </div>
        </div>

        <!-- ASSESSMENT ACTION MODAL -->
        <div id="assess-modal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center p-6 z-[200]">
            <div class="bg-white p-10 rounded-[3rem] w-full max-w-sm shadow-2xl text-center">
                <h3 id="modal-student-name" class="font-bold text-2xl mb-8">生徒名</h3>
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="recordAction('発言・挙手')" class="py-5 bg-emerald-50 text-emerald-700 rounded-3xl font-bold border border-emerald-100 hover:bg-emerald-100">発言・挙手</button>
                    <button onclick="recordAction('協働・教え合い')" class="py-5 bg-emerald-50 text-emerald-700 rounded-3xl font-bold border border-emerald-100 hover:bg-emerald-100">協働・教え合い</button>
                    <button onclick="recordAction('私語・集中欠如')" class="py-5 bg-rose-50 text-rose-700 rounded-3xl font-bold border border-rose-100 hover:bg-rose-100">私語・集中欠如</button>
                    <button onclick="recordAction('離席・他事')" class="py-5 bg-rose-50 text-rose-700 rounded-3xl font-bold border border-rose-100 hover:bg-rose-100">離席・他事</button>
                </div>
                <button onclick="closeAssessModal()" class="mt-8 w-full py-2 text-gray-300 font-bold">閉じる</button>
            </div>
        </div>

    </div>

    <script>
        const apiKey = ""; 

        let state = {
            plans: JSON.parse(localStorage.getItem('n_plans_v2') || '[]'),
            classes: JSON.parse(localStorage.getItem('n_classes_v2') || '[]'),
            periods: JSON.parse(localStorage.getItem('n_periods_v2') || '{"1":{"s":"08:45","e":"09:35"},"2":{"s":"09:45","e":"10:35"},"3":{"s":"10:45","e":"11:35"},"4":{"s":"11:45","e":"12:35"},"5":{"s":"13:30","e":"14:20"},"6":{"s":"14:30","e":"15:20"}}'),
            logs: JSON.parse(localStorage.getItem('n_logs_v2') || '[]'),
            activePlan: null,
            activeStudent: null,
            previewGrid: [],
            draggedIndex: null,
            extractedKeywords: [],
            tempAICriteria: []
        };

        // --- Core Functions ---

        function switchTab(tabId) {
            // セクションの切り替え
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`view-${tabId}`);
            if (target) target.classList.remove('hidden');

            // ナビゲーションの切り替え
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const activeNav = document.getElementById(`btn-nav-${tabId}`);
            if (activeNav) activeNav.classList.add('active');
            
            // タイトル更新
            const titles = { 'home': 'ホーム', 'plan': '授業計画', 'seating-config': '座席表設定', 'assessment': '授業評価', 'settings': '設定' };
            document.getElementById('page-title').innerText = titles[tabId] || 'ホーム';

            // 各ビューのレンダリング
            if (tabId === 'home') renderHome();
            if (tabId === 'plan') renderPlanInputs();
            if (tabId === 'seating-config') renderSeatingConfig();
            if (tabId === 'settings') renderSettings();
        }

        function renderHome() {
            const today = new Date().toISOString().split('T')[0];
            const tPlans = state.plans.filter(p => p.date === today).sort((a,b)=>a.period - b.period);
            const oPlans = state.plans.filter(p => p.date !== today).sort((a,b)=>new Date(a.date) - new Date(b.date));

            document.getElementById('today-schedule').innerHTML = tPlans.length ? tPlans.map(p => `
                <div onclick="startLesson('${p.id}')" class="bg-white p-6 rounded-[2rem] soft-shadow border-l-[12px] border-rose-400 flex justify-between items-center group hover:bg-rose-50 cursor-pointer">
                    <div>
                        <p class="text-[10px] font-bold text-rose-300">${p.period}時間目</p>
                        <h3 class="text-xl font-bold text-gray-700">${p.subject}</h3>
                    </div>
                    <div class="px-4 py-2 bg-rose-500 text-white rounded-xl font-bold">START</div>
                </div>
            `).join('') : '<p class="text-center py-10 bg-white rounded-3xl border border-dashed text-gray-300">本日の授業はありません</p>';

            document.getElementById('other-schedule').innerHTML = oPlans.map(p => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-gray-100">
                    <div class="flex items-center gap-4">
                        <span class="text-[10px] font-bold bg-gray-50 text-gray-400 p-2 rounded-lg">${p.date}</span>
                        <span class="font-bold text-gray-600">${p.subject}</span>
                    </div>
                    <button onclick="startLesson('${p.id}')" class="text-rose-400 font-bold text-xs p-2">開始</button>
                </div>
            `).join('');
        }

        function renderPlanInputs() {
            const pSelect = document.getElementById('plan-period');
            pSelect.innerHTML = Object.keys(state.periods).map(p => `<option value="${p}">${p}時間目</option>`).join('');
            const cSelect = document.getElementById('plan-class-id');
            cSelect.innerHTML = '<option value="">クラスを選択してください</option>' + 
                state.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function generateAICriteria() {
            const rawText = document.getElementById('plan-raw-criteria').value;
            const focus = document.getElementById('plan-focus-point').value;
            if (!rawText) return alert("テキストを入力してください");

            const btn = document.getElementById('btn-ai-generate');
            const originalText = btn.innerText;
            btn.innerText = "解析中...";

            const prompt = `
            以下の授業評価基準から、特に重要な「キーワード」を5個抽出し、その後に「観察すべき具体的行動目安」を3つ作成してください。
            【条件】
            ・行動目安は20文字以内で「〜している。」という形。
            ・先生の注目ポイントも考慮：${focus || 'なし'}
            【出力形式】
            キーワード: A, B, C, D, E
            目安1: ○○している。
            目安2: △△している。
            目安3: □□している。`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: rawText }] }],
                        systemInstruction: { parts: [{ text: prompt }] }
                    })
                });
                const result = await response.json();
                const out = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                
                const kLine = out.match(/キーワード: (.*)/);
                if (kLine) state.extractedKeywords = kLine[1].split(',').map(s=>s.trim());
                
                const mLines = out.match(/目安[1-3]: (.*)/g);
                if (mLines) {
                    state.tempAICriteria = mLines.map(l => l.replace(/目安[1-3]: /, ""));
                    renderAICriteria();
                }
            } catch (e) { console.error(e); } finally { btn.innerText = originalText; }
        }

        function renderAICriteria() {
            const box = document.getElementById('ai-insight-box');
            box.classList.remove('hidden');
            document.getElementById('ai-criteria-list').innerHTML = state.tempAICriteria.map(c => `
                <li class="flex items-start gap-3 bg-white p-3 rounded-xl border border-indigo-100 text-sm text-gray-600 font-bold">
                    <span class="w-5 h-5 bg-indigo-500 text-white rounded-full flex items-center justify-center text-[10px] flex-shrink-0 mt-0.5">✔</span>
                    ${c}
                </li>
            `).join('');
        }

        function showAIAssistant() {
            const chipCont = document.getElementById('keyword-chips');
            chipCont.innerHTML = state.extractedKeywords.map(k => `
                <button onclick="this.classList.toggle('bg-indigo-500'); this.classList.toggle('text-white');" 
                        class="px-4 py-2 bg-white border border-indigo-100 rounded-xl text-xs font-bold text-indigo-400">
                    ${k}
                </button>
            `).join('');
            document.getElementById('ai-modal').classList.remove('hidden');
        }

        function closeAIModal() { document.getElementById('ai-modal').classList.add('hidden'); }

        async function executeAIRebuild() {
            const selectedChips = Array.from(document.querySelectorAll('#keyword-chips .text-white')).map(el => el.innerText);
            const custom = document.getElementById('ai-custom-prompt').value;
            const prompt = `${selectedChips.join(',')}と指示(${custom})を反映して、観察ポイントを3つ作り直して。20文字以内、「〜している」形式。`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                const out = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                const mLines = out.match(/[1-3]. (.*)/g) || out.match(/・(.*)/g);
                if (mLines) {
                    state.tempAICriteria = mLines.map(l => l.replace(/^[1-3]. |^・/, ""));
                    renderAICriteria();
                    closeAIModal();
                }
            } catch (e) { console.error(e); }
        }

        function savePlan() {
            const subj = document.getElementById('plan-subject').value;
            const cid = document.getElementById('plan-class-id').value;
            const date = document.getElementById('plan-date').value;
            if (!subj || !cid || !date) return alert("必要事項を入力してください");
            
            const plan = {
                id: document.getElementById('edit-plan-id').value || Date.now().toString(),
                subject: subj,
                date: date,
                period: document.getElementById('plan-period').value,
                classId: cid,
                aiCriteria: state.tempAICriteria
            };

            const idx = state.plans.findIndex(p => p.id === plan.id);
            if (idx > -1) state.plans[idx] = plan; else state.plans.push(plan);

            localStorage.setItem('n_plans_v2', JSON.stringify(state.plans));
            switchTab('home');
        }

        function startLesson(id) {
            const plan = state.plans.find(p => p.id === id);
            const classInfo = state.classes.find(c => c.id === plan.classId);
            if (!classInfo) return alert("座席表が見つかりません");

            state.activePlan = plan;
            switchTab('assessment');
            document.getElementById('page-title').innerText = plan.subject;
            document.getElementById('assess-ai-points').innerText = plan.aiCriteria?.join(' / ') || "AIポイント未設定";

            const grid = document.getElementById('assess-seating-grid');
            grid.style.gridTemplateColumns = `repeat(${classInfo.cols}, minmax(0, 1fr))`;
            grid.innerHTML = classInfo.students.map((name) => `
                <div onclick="${name ? `openAssess('${name}')` : ''}" 
                     class="seat h-24 ${name ? 'bg-white' : 'bg-gray-50 border-dashed text-transparent'}">
                    ${name || ''}
                </div>
            `).join('');
            renderLogs();
        }

        function openAssess(name) {
            state.activeStudent = name;
            document.getElementById('modal-student-name').innerText = name;
            document.getElementById('assess-modal').classList.remove('hidden');
        }

        function closeAssessModal() { document.getElementById('assess-modal').classList.add('hidden'); }

        function recordAction(action) {
            const log = {
                id: Date.now().toString(),
                planId: state.activePlan.id,
                student: state.activeStudent,
                action: action,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            };
            state.logs.unshift(log);
            localStorage.setItem('n_logs_v2', JSON.stringify(state.logs));
            renderLogs();
            closeAssessModal();
        }

        function renderLogs() {
            const cont = document.getElementById('live-logs');
            const classLogs = state.logs.filter(l => l.planId === state.activePlan.id);
            cont.innerHTML = classLogs.map(l => `
                <div onclick="deleteLog('${l.id}')" class="p-3 bg-gray-50 rounded-2xl flex justify-between items-center animate-fadeIn cursor-pointer hover:bg-rose-50">
                    <span class="font-bold text-gray-600">${l.student}</span>
                    <span class="${l.action.match(/私語|離席/) ? 'text-rose-500' : 'text-emerald-600'} font-bold">${l.action}</span>
                    <span class="text-[10px] text-gray-300">${l.time}</span>
                </div>
            `).join('') || '<p class="text-center py-10 text-gray-300">ログなし</p>';
        }

        function deleteLog(id) {
            state.logs = state.logs.filter(l => l.id !== id);
            localStorage.setItem('n_logs_v2', JSON.stringify(state.logs));
            renderLogs();
        }

        // --- Seating Config ---
        function updateSeatPreview() {
            const cols = parseInt(document.getElementById('seat-cols').value) || 1;
            const rows = parseInt(document.getElementById('seat-rows').value) || 1;
            const count = parseInt(document.getElementById('seat-count').value) || 0;
            const names = document.getElementById('student-list').value.split('\n').map(n=>n.trim()).filter(n=>n);
            
            const container = document.getElementById('seating-preview');
            container.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            
            let grid = Array(rows * cols).fill(null);
            names.forEach((name, i) => { if (i < count && i < grid.length) grid[i] = name; });
            state.previewGrid = grid;
            renderPreview();
        }

        function renderPreview() {
            const container = document.getElementById('seating-preview');
            container.innerHTML = state.previewGrid.map((name, i) => `
                <div draggable="true" ondragstart="state.draggedIndex=${i}" ondragover="event.preventDefault()" ondrop="swapPreview(${i})"
                     class="seat h-12 ${name ? 'text-gray-700' : 'text-transparent border-dashed bg-gray-50'}">
                    ${name ? name.substring(0,2) : ''}
                </div>
            `).join('');
        }

        function swapPreview(i) {
            const temp = state.previewGrid[i];
            state.previewGrid[i] = state.previewGrid[state.draggedIndex];
            state.previewGrid[state.draggedIndex] = temp;
            renderPreview();
        }

        function saveClassSeating() {
            const name = document.getElementById('class-name').value;
            if (!name) return alert("クラス名を入力してください");
            const newClass = {
                id: Date.now().toString(),
                name: name,
                cols: parseInt(document.getElementById('seat-cols').value),
                rows: parseInt(document.getElementById('seat-rows').value),
                count: parseInt(document.getElementById('seat-count').value),
                students: state.previewGrid
            };
            state.classes.push(newClass);
            localStorage.setItem('n_classes_v2', JSON.stringify(state.classes));
            renderSeatingConfig();
        }

        function renderSeatingConfig() {
            const cont = document.getElementById('saved-classes');
            cont.innerHTML = state.classes.map(c => `
                <div class="bg-white p-5 rounded-3xl flex justify-between items-center soft-shadow border border-gray-50">
                    <div><div class="font-bold text-gray-700">${c.name}</div></div>
                    <button onclick="deleteClass('${c.id}')" class="text-rose-200">削除</button>
                </div>
            `).join('');
            updateSeatPreview();
        }

        function deleteClass(id) {
            state.classes = state.classes.filter(c => c.id !== id);
            localStorage.setItem('n_classes_v2', JSON.stringify(state.classes));
            renderSeatingConfig();
        }

        // --- Settings ---
        function renderSettings() {
            const cont = document.getElementById('period-settings');
            cont.innerHTML = Object.entries(state.periods).sort((a,b)=>a[0]-b[0]).map(([p, t]) => `
                <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
                    <span class="w-10 h-10 bg-white rounded-full flex items-center justify-center font-bold text-rose-500">${p}</span>
                    <input type="time" value="${t.s}" onchange="updatePeriodTime('${p}', 's', this.value)" class="bg-white border-none rounded-xl p-2 text-sm">
                    <span>~</span>
                    <input type="time" value="${t.e}" onchange="updatePeriodTime('${p}', 'e', this.value)" class="bg-white border-none rounded-xl p-2 text-sm">
                    <button onclick="removePeriodSlot('${p}')" class="text-rose-300 ml-auto">✕</button>
                </div>
            `).join('');
        }

        function addPeriodSlot() {
            const max = Math.max(...Object.keys(state.periods).map(Number), 0);
            state.periods[(max + 1).toString()] = { s: "08:45", e: "09:35" };
            renderSettings();
        }

        function removePeriodSlot(p) { delete state.periods[p]; renderSettings(); }
        function updatePeriodTime(p, type, val) { if(state.periods[p]) state.periods[p][type] = val; }
        function saveSettings() { localStorage.setItem('n_periods_v2', JSON.stringify(state.periods)); alert("保存しました"); }

        window.onload = () => switchTab('home');
    </script>
</body>
</html>
