<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å“¡å‘ã‘æˆæ¥­è©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #4f46e5; }
        body { background-color: #f8fafc; font-family: sans-serif; overflow-x: hidden; color: #1e293b; }
        .page { display: none; }
        .page.active { display: block; }
        .seat { aspect-ratio: 1 / 1; transition: all 0.2s; position: relative; }
        .preview-seat { aspect-ratio: 1 / 1; border: 1px solid #e2e8f0; border-radius: 2px; }
        .log-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .loading-dots:after { content: '...'; animation: dots 1.5s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
</head>
<body class="pb-28">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t flex justify-around p-3 z-50 shadow-2xl">
            <button onclick="showPage('dashboard')" class="flex flex-col items-center text-gray-400 hover:text-indigo-600 focus:text-indigo-600">
                <span class="text-xl">ğŸ </span><span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
            </button>
            <button onclick="showPage('schedule')" class="flex flex-col items-center text-gray-400 hover:text-indigo-600 focus:text-indigo-600">
                <span class="text-xl">ğŸ“…</span><span class="text-[10px] font-bold">äºˆå®šãƒ»åŸºæº–</span>
            </button>
            <button onclick="showPage('class-config')" class="flex flex-col items-center text-gray-400 hover:text-indigo-600 focus:text-indigo-600">
                <span class="text-xl">ğŸ‘¥</span><span class="text-[10px] font-bold">åº§å¸­è¨­å®š</span>
            </button>
            <button onclick="showPage('settings')" class="flex flex-col items-center text-gray-400 hover:text-indigo-600 focus:text-indigo-600">
                <span class="text-xl">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span>
            </button>
        </nav>

        <!-- Page: Dashboard (Home) -->
        <section id="page-dashboard" class="page active">
            <header class="flex justify-between items-end mb-8 pt-4">
                <div>
                    <p id="dashboard-date" class="text-sm font-bold text-indigo-600 mb-1"></p>
                    <h1 class="text-3xl font-black tracking-tight">æˆæ¥­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                </div>
                <div class="text-right">
                    <p id="current-time-display" class="text-2xl font-mono font-bold text-gray-400"></p>
                </div>
            </header>

            <div class="space-y-8">
                <!-- Today's Classes -->
                <div>
                    <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span> æœ¬æ—¥ã®æˆæ¥­
                    </h2>
                    <div id="today-list" class="space-y-3"></div>
                </div>

                <!-- Upcoming/History Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">ğŸ“… æ˜æ—¥ä»¥é™ã®äºˆå®š</h2>
                        <div id="upcoming-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">ğŸ•’ å±¥æ­´ãƒ»ç¶šãã‹ã‚‰è©•ä¾¡</h2>
                        <div id="history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Page: Schedule & AI Criteria -->
        <section id="page-schedule" class="page">
            <h1 class="text-2xl font-black mb-6">æˆæ¥­ç™»éŒ²ãƒ»ç·¨é›†</h1>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 space-y-6">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">å®Ÿæ–½æ—¥</label>
                        <input type="date" id="input-date" class="w-full border-2 border-gray-50 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white focus:border-indigo-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">æ™‚é™</label>
                        <select id="input-period" class="w-full border-2 border-gray-50 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white focus:border-indigo-500 outline-none transition-all"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">ã‚¯ãƒ©ã‚¹ãƒ»ç§‘ç›®å</label>
                    <input type="text" id="input-class" placeholder="1å¹´Açµ„ æ•°å­¦" class="w-full border-2 border-gray-50 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white focus:border-indigo-500 outline-none transition-all">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">è©•ä¾¡åŸºæº–ã®åŸæ–‡ (æ•™ç§‘æ›¸ç­‰)</label>
                    <textarea id="input-criteria" rows="3" class="w-full border-2 border-gray-50 bg-gray-50 p-3 rounded-xl text-sm focus:bg-white focus:border-indigo-500 outline-none transition-all" placeholder="ä¾‹ï¼šä¸‰è§’å½¢ã®åˆåŒæ¡ä»¶ã‚’ç†è§£ã—ã€å›³å½¢ã®æ€§è³ªã‚’è«–ç†çš„ã«è€ƒå¯Ÿã§ãã‚‹ã€‚"></textarea>
                </div>

                <!-- AI Section -->
                <div class="bg-indigo-50/50 p-5 rounded-3xl border-2 border-indigo-100/50 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">âœ¨</span>
                            <span class="text-xs font-black text-indigo-700">AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆä½œæˆ</span>
                        </div>
                        <button onclick="handleAIGenerate()" id="ai-gen-btn" class="bg-indigo-600 text-white text-[10px] font-black px-5 py-2 rounded-full hover:bg-indigo-700 transition active:scale-95 shadow-lg shadow-indigo-200">AIã«ä½œæˆã•ã›ã‚‹</button>
                    </div>
                    
                    <div id="ai-result-display" class="bg-white p-4 rounded-2xl min-h-[80px] border border-indigo-100 shadow-inner">
                        <p id="ai-placeholder" class="text-gray-400 text-[11px] leading-relaxed">åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€è¦³å¯Ÿã™ã¹ãè¡Œå‹•ã®ç›®å®‰ã‚’3ã¤ä½œæˆã—ã¾ã™ã€‚</p>
                        <ul id="ai-points-list" class="text-xs text-indigo-900 font-bold space-y-2"></ul>
                    </div>

                    <div id="ai-keyword-box" class="hidden animate-fade-in">
                        <div id="keyword-chips" class="flex flex-wrap gap-2 mb-3"></div>
                        <div class="flex gap-2">
                            <input type="text" id="custom-keyword" placeholder="è‡ªç”±ãƒ¯ãƒ¼ãƒ‰ã§ä¿®æ­£..." class="flex-1 text-[11px] border-none bg-white p-2.5 rounded-xl shadow-sm">
                            <button onclick="handleAIGenerate(true)" class="bg-white text-indigo-600 border-2 border-indigo-100 text-[10px] font-black px-4 py-2 rounded-xl">å†ç”Ÿæˆ</button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="saveSchedule()" id="save-btn" class="flex-1 gradient-bg text-white py-4 rounded-2xl font-black shadow-xl shadow-indigo-200 active:scale-[0.98] transition">æˆæ¥­ã‚’ç™»éŒ²ã™ã‚‹</button>
                    <button onclick="resetForm()" id="cancel-btn" class="bg-gray-100 text-gray-500 px-6 py-4 rounded-2xl font-bold text-sm hidden">ä¸­æ­¢</button>
                </div>
            </div>
            <div id="all-schedule-list" class="mt-12 space-y-3 pb-10"></div>
        </section>

        <!-- Page: Class Config (Visual Seating) -->
        <section id="page-class-config" class="page">
            <h1 class="text-2xl font-black mb-2">åº§å¸­ãƒ»åç°¿ã®è¨­å®š</h1>
            <p class="text-xs text-gray-400 mb-6 font-bold uppercase tracking-tighter">å·¦å‰ã‹ã‚‰å³ã«å‘ã‹ã£ã¦é †ã«é…ç½®ã•ã‚Œã¾ã™</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                <div class="bg-white p-6 rounded-3xl shadow-sm border space-y-6">
                    <div>
                        <label class="block text-xs font-black text-gray-400 mb-2 uppercase">ç”Ÿå¾’åç°¿ï¼ˆ1è¡Œã«1äººï¼‰</label>
                        <textarea id="student-list-input" oninput="updatePreview()" rows="12" class="w-full bg-gray-50 border-2 border-gray-50 p-4 rounded-2xl text-sm font-mono focus:bg-white focus:border-indigo-500 outline-none transition-all" placeholder="ç”°ä¸­ å¤ªéƒ&#10;ä½è—¤ èŠ±å­..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-black text-gray-400 mb-2 uppercase">æ¨ªã®åˆ—æ•°</label>
                            <input type="number" id="grid-cols" value="6" oninput="updatePreview()" class="w-full bg-gray-50 border-none p-3 rounded-xl text-sm font-black text-center">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-gray-400 mb-2 uppercase">ç·å¸­æ•°</label>
                            <input type="number" id="total-seats" value="36" oninput="updatePreview()" class="w-full bg-gray-50 border-none p-3 rounded-xl text-sm font-black text-center">
                        </div>
                    </div>
                    <button onclick="saveClassConfig()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black shadow-xl shadow-gray-200 active:scale-[0.98] transition">ã“ã®è¨­å®šã§ä¿å­˜</button>
                </div>

                <!-- Realtime Preview -->
                <div class="bg-gray-100 p-6 rounded-3xl border border-gray-200 sticky top-4">
                    <h3 class="text-[10px] font-black text-gray-400 mb-4 uppercase text-center tracking-widest">é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div class="w-16 h-1 mx-auto bg-gray-300 rounded-full mb-6"></div>
                    <div id="seating-preview" class="grid gap-1.5"></div>
                    <div class="mt-6 flex items-center justify-center gap-4">
                        <div class="flex items-center gap-1 text-[9px] font-bold text-gray-400">
                            <span class="w-2 h-2 bg-indigo-500 rounded-sm"></span> å…¥åŠ›æ¸ˆ
                        </div>
                        <div class="flex items-center gap-1 text-[9px] font-bold text-gray-400">
                            <span class="w-2 h-2 bg-white border border-gray-300 rounded-sm"></span> ç©ºå¸­
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Page: Classroom (Live Eval) -->
        <section id="page-classroom" class="page">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="showPage('dashboard')" class="bg-white w-10 h-10 rounded-full border shadow-sm flex items-center justify-center font-bold text-gray-400 hover:text-indigo-600 transition">â†</button>
                    <div>
                        <h2 id="view-class-title" class="text-xl font-black"></h2>
                        <p id="view-class-info" class="text-[10px] font-bold text-indigo-500 uppercase"></p>
                    </div>
                </div>
            </div>

            <div class="bg-amber-100/50 border border-amber-200 p-4 rounded-3xl mb-6">
                <p class="text-[9px] font-black text-amber-600 uppercase mb-2">AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ</p>
                <div id="view-ai-points" class="text-xs font-bold text-amber-900 grid gap-1.5"></div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Seating Grid -->
                <div class="flex-1 bg-gray-200 p-5 rounded-[40px] border-8 border-gray-100 shadow-inner">
                    <div class="w-32 mx-auto bg-white/40 py-1.5 text-[10px] text-center font-black text-gray-400 rounded-full mb-8 border border-white/50 uppercase tracking-widest">Blackboard</div>
                    <div id="seating-grid" class="grid gap-3"></div>
                </div>

                <!-- Live Log Sidebar -->
                <div class="w-full lg:w-72 flex flex-col gap-4">
                    <div class="bg-white p-5 rounded-3xl border shadow-sm flex flex-col h-[500px]">
                        <h3 class="text-xs font-black text-gray-400 mb-4 border-b pb-3 uppercase tracking-widest">æœ¬æ—¥ã®è©•ä¾¡ãƒ­ã‚°</h3>
                        <div id="live-log-list" class="flex-1 overflow-y-auto space-y-3 pr-1 scroll-hide"></div>
                        <div id="empty-log-msg" class="text-[10px] text-gray-300 text-center py-10 italic">è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Page: Settings -->
        <section id="page-settings" class="page">
            <h1 class="text-2xl font-black mb-6">è¨­å®š</h1>
            <div class="bg-white p-6 rounded-3xl border space-y-6">
                <div>
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-4">æˆæ¥­æ™‚é–“å‰²ã®è¨­å®š</h3>
                    <div id="time-config-list" class="space-y-3"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Evaluation Modal -->
    <div id="eval-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center hidden">
        <div class="bg-white w-full max-w-sm p-8 rounded-[40px] shadow-2xl m-4 border border-white/20">
            <div class="text-center mb-6">
                <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Evaluating</p>
                <h3 id="modal-student-name" class="text-3xl font-black">ç”Ÿå¾’å</h3>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="recordEval('æŒ™æ‰‹ãƒ»ç™ºè¨€')" class="bg-gray-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-indigo-500 hover:bg-white transition-all">ğŸ™‹ ç™ºè¨€</button>
                <button onclick="recordEval('ä»–è€…ã¸åŠ©è¨€')" class="bg-gray-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-indigo-500 hover:bg-white transition-all">ğŸ¤ åŠ©è¨€</button>
                <button onclick="recordEval('é‹­ã„è€ƒå¯Ÿ')" class="bg-gray-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-indigo-500 hover:bg-white transition-all">ğŸ’¡ è€ƒå¯Ÿ</button>
                <button onclick="recordEval('ç¶™ç¶šçš„é›†ä¸­')" class="bg-gray-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-indigo-500 hover:bg-white transition-all">ğŸ“– é›†ä¸­</button>
                <button onclick="recordEval('ä¸é©åˆ‡ç™ºè¨€')" class="bg-rose-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-rose-500 hover:bg-white transition-all text-rose-600">ğŸ“¢ é¨’ãŒã—ã„</button>
                <button onclick="recordEval('ä¸­æ–­è¡Œç‚º')" class="bg-rose-50 p-4 rounded-2xl text-[11px] font-black border-2 border-transparent hover:border-rose-500 hover:bg-white transition-all text-rose-600">âš ï¸ ä¸­æ–­</button>
            </div>
            <button onclick="closeModal()" class="w-full mt-8 py-2 text-gray-300 font-bold text-xs uppercase tracking-widest hover:text-gray-500 transition">Close</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-8 py-4 rounded-full shadow-2xl text-xs font-black opacity-0 transition-all z-[200] pointer-events-none uppercase tracking-widest"></div>

    <script>
        const apiKey = "";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edu-manager-v5-final';

        let state = {
            schedules: JSON.parse(localStorage.getItem(`${appId}_schedules`)) || [],
            logs: JSON.parse(localStorage.getItem(`${appId}_logs`)) || [],
            classConfig: JSON.parse(localStorage.getItem(`${appId}_classConfig`)) || {
                students: ["ç”Ÿå¾’A", "ç”Ÿå¾’B", "ç”Ÿå¾’C", "ç”Ÿå¾’D"],
                cols: 6,
                total: 36
            },
            timeConfig: JSON.parse(localStorage.getItem(`${appId}_timeConfig`)) || [
                { id: 1, label: "1æ ¡æ™‚", start: "08:50", end: "09:40" },
                { id: 2, label: "2æ ¡æ™‚", start: "09:50", end: "10:40" },
                { id: 3, label: "3æ ¡æ™‚", start: "10:50", end: "11:40" },
                { id: 4, label: "4æ ¡æ™‚", start: "11:50", end: "12:40" },
                { id: 5, label: "5æ ¡æ™‚", start: "13:30", end: "14:20" },
                { id: 6, label: "6æ ¡æ™‚", start: "14:30", end: "15:20" }
            ],
            currentAiPoints: [],
            selectedStudent: null,
            selectedClassId: null
        };

        // --- Core Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'schedule') renderScheduleList();
            if (pageId === 'class-config') {
                renderClassConfig();
                updatePreview();
            }
            if (pageId === 'settings') renderSettings();
            window.scrollTo(0, 0);
        }

        // --- Dashboard Management ---
        function renderDashboard() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            document.getElementById('dashboard-date').innerText = now.toLocaleDateString('ja-JP', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-time-display').innerText = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

            const todayList = document.getElementById('today-list');
            const upcomingList = document.getElementById('upcoming-list');
            const historyList = document.getElementById('history-list');

            todayList.innerHTML = upcomingList.innerHTML = historyList.innerHTML = '';

            const items = [...state.schedules].sort((a, b) => new Date(`${a.date} ${state.timeConfig.find(p => p.id == a.periodId)?.start}`) - new Date(`${b.date} ${state.timeConfig.find(p => p.id == b.periodId)?.start}`));

            const todayItems = items.filter(s => s.date === todayStr);
            const futureItems = items.filter(s => s.date > todayStr).slice(0, 5);
            const pastItems = items.filter(s => s.date <= todayStr).reverse().slice(0, 5);

            // Today's Display
            if (todayItems.length === 0) {
                todayList.innerHTML = '<div class="bg-white p-12 rounded-[40px] border border-dashed text-center text-gray-300 font-bold text-sm">ä»Šæ—¥ã®æˆæ¥­ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
            } else {
                todayItems.forEach(s => todayList.appendChild(createClassCard(s, true)));
            }

            // Future Display
            if (futureItems.length === 0) {
                upcomingList.innerHTML = '<p class="text-[10px] text-gray-300 font-bold italic">äºˆå®šãªã—</p>';
            } else {
                futureItems.forEach(s => upcomingList.appendChild(createClassCard(s, false, 'future')));
            }

            // History Display
            if (pastItems.length === 0) {
                historyList.innerHTML = '<p class="text-[10px] text-gray-300 font-bold italic">å±¥æ­´ãªã—</p>';
            } else {
                pastItems.forEach(s => historyList.appendChild(createClassCard(s, false, 'history')));
            }
        }

        function createClassCard(s, isLarge = false, type = 'today') {
            const conf = state.timeConfig.find(p => p.id == s.periodId);
            const el = document.createElement('div');
            
            if (isLarge) {
                el.className = "bg-white p-6 rounded-[32px] border-2 border-transparent hover:border-indigo-500 shadow-sm transition-all cursor-pointer group";
                el.onclick = () => openClassroom(s);
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[10px] font-black bg-indigo-50 text-indigo-500 px-3 py-1 rounded-full uppercase mb-2 inline-block">${conf?.label}</span>
                            <h3 class="text-xl font-black group-hover:text-indigo-600 transition-colors">${s.className}</h3>
                            <p class="text-[10px] font-bold text-gray-400 mt-1">${conf?.start} â€” ${conf?.end}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-2xl group-hover:bg-indigo-600 group-hover:text-white transition-all font-black text-sm">è©•ä¾¡ã‚’ã¯ã˜ã‚ã‚‹ â†’</div>
                    </div>
                `;
            } else {
                el.className = "bg-white p-3 rounded-2xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors";
                el.onclick = () => openClassroom(s);
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-[9px] font-black text-gray-400 w-12">${type === 'future' ? s.date.slice(5) : conf?.label}</div>
                        <div class="text-xs font-bold text-gray-700">${s.className}</div>
                    </div>
                    <span class="text-[10px] font-black text-indigo-500">OPEN</span>
                `;
            }
            return el;
        }

        // --- AI Extraction Logic ---
        async function handleAIGenerate(isRegen = false) {
            const crit = document.getElementById('input-criteria').value;
            if (!crit) return showToast("å…ˆã«åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const btn = document.getElementById('ai-gen-btn');
            const placeholder = document.getElementById('ai-placeholder');
            const list = document.getElementById('ai-points-list');
            
            btn.disabled = true; btn.innerText = "ç”Ÿæˆä¸­...";
            placeholder.innerHTML = '<span class="loading-dots">AIãŒæˆæ¥­ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã„ã¾ã™</span>';
            list.innerHTML = "";

            let prompt = `ä»¥ä¸‹ã®è©•ä¾¡åŸºæº–ã‚’ã‚‚ã¨ã«ã€æˆæ¥­ä¸­ã«æ•™å¸«ãŒæœºé–“å·¡è¦–ã§è¦³å¯Ÿã™ã¹ãã€Œç”Ÿå¾’ã®å…·ä½“çš„è¡Œå‹•ã€ã‚’3ç‚¹ã€20æ–‡å­—ä»¥å†…ã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚èªå°¾ã¯ã€Œãƒ»ã€œã—ã¦ã„ã‚‹ã€ã§çµ±ä¸€ã€‚
            åŸºæº–: ${crit}`;

            if (isRegen) {
                const custom = document.getElementById('custom-keyword').value;
                prompt += `\nè¿½åŠ ã®é‡è¦–äº‹é …: ${custom}`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                state.currentAiPoints = text.split('\n').filter(l => l.includes('ãƒ»')).map(l => l.trim()).slice(0, 3);
                
                placeholder.classList.add('hidden');
                list.innerHTML = state.currentAiPoints.map(p => `<li>${p}</li>`).join('');
                document.getElementById('ai-keyword-box').classList.remove('hidden');
            } catch (e) {
                placeholder.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
            } finally {
                btn.disabled = false; btn.innerText = isRegen ? "å†ç”Ÿæˆ" : "AIã«ä½œæˆã•ã›ã‚‹";
            }
        }

        // --- Seating Visualizer ---
        function updatePreview() {
            const raw = document.getElementById('student-list-input').value;
            const students = raw.split('\n').map(s => s.trim()).filter(s => s);
            const cols = parseInt(document.getElementById('grid-cols').value) || 6;
            const total = parseInt(document.getElementById('total-seats').value) || 36;
            
            const preview = document.getElementById('seating-preview');
            preview.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            preview.innerHTML = '';

            for (let i = 0; i < total; i++) {
                const dot = document.createElement('div');
                dot.className = `preview-seat ${students[i] ? 'bg-indigo-500 border-indigo-600 shadow-sm' : 'bg-white border-gray-200'}`;
                preview.appendChild(dot);
            }
        }

        function saveClassConfig() {
            const raw = document.getElementById('student-list-input').value;
            state.classConfig = {
                students: raw.split('\n').map(s => s.trim()).filter(s => s),
                cols: parseInt(document.getElementById('grid-cols').value) || 6,
                total: parseInt(document.getElementById('total-seats').value) || 36
            };
            localStorage.setItem(`${appId}_classConfig`, JSON.stringify(state.classConfig));
            showToast("åº§å¸­ãƒ»åç°¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function renderClassConfig() {
            document.getElementById('student-list-input').value = state.classConfig.students.join('\n');
            document.getElementById('grid-cols').value = state.classConfig.cols;
            document.getElementById('total-seats').value = state.classConfig.total;
        }

        // --- Schedule & Evaluation Persistence ---
        function saveSchedule() {
            const id = document.getElementById('edit-id').value || Date.now().toString();
            const date = document.getElementById('input-date').value;
            const period = document.getElementById('input-period').value;
            const cls = document.getElementById('input-class').value;
            const crit = document.getElementById('input-criteria').value;

            if (!date || !cls) return showToast("æ—¥ä»˜ã¨ã‚¯ãƒ©ã‚¹åã¯å¿…é ˆã§ã™");

            const data = { id, date, periodId: period, className: cls, criteria: crit, aiPoints: state.currentAiPoints };
            const idx = state.schedules.findIndex(s => s.id === id);
            if (idx > -1) state.schedules[idx] = data;
            else state.schedules.push(data);

            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            resetForm();
            showPage('dashboard');
            showToast("ä¿å­˜å®Œäº†");
        }

        function resetForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('input-class').value = '';
            document.getElementById('input-criteria').value = '';
            document.getElementById('ai-points-list').innerHTML = '';
            document.getElementById('ai-placeholder').classList.remove('hidden');
            document.getElementById('ai-keyword-box').classList.add('hidden');
            document.getElementById('save-btn').innerText = "æˆæ¥­ã‚’ç™»éŒ²ã™ã‚‹";
            state.currentAiPoints = [];
        }

        function openClassroom(s) {
            state.selectedClassId = s.id;
            document.getElementById('view-class-title').innerText = s.className;
            const conf = state.timeConfig.find(p => p.id == s.periodId);
            document.getElementById('view-class-info').innerText = `${s.date} â€” ${conf?.label || ''}`;
            document.getElementById('view-ai-points').innerHTML = s.aiPoints.map(p => `<div>âœ… ${p}</div>`).join('') || "è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆãªã—";
            renderLiveSeating();
            renderLogs();
            showPage('classroom');
        }

        function renderLiveSeating() {
            const grid = document.getElementById('seating-grid');
            const { cols, total, students } = state.classConfig;
            grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            grid.innerHTML = '';

            for (let i = 0; i < total; i++) {
                const name = students[i] || "";
                const seat = document.createElement('div');
                if (name) {
                    seat.className = "seat bg-white border-2 border-transparent rounded-2xl flex items-center justify-center p-2 cursor-pointer shadow-sm hover:border-indigo-500 hover:shadow-lg transition-all active:scale-95";
                    seat.innerHTML = `<span class="text-[10px] font-black text-gray-700 text-center leading-tight">${name}</span>`;
                    seat.onclick = () => {
                        state.selectedStudent = { idx: i, name };
                        document.getElementById('modal-student-name').innerText = name;
                        document.getElementById('eval-modal').classList.remove('hidden');
                    };
                } else {
                    seat.className = "seat bg-gray-300/20 border-2 border-dashed border-gray-300/40 rounded-2xl";
                }
                grid.appendChild(seat);
            }
        }

        function recordEval(action) {
            const log = {
                id: Date.now(),
                classId: state.selectedClassId,
                name: state.selectedStudent.name,
                action: action,
                time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            };
            state.logs.push(log);
            localStorage.setItem(`${appId}_logs`, JSON.stringify(state.logs));
            renderLogs();
            closeModal();
            showToast(`${state.selectedStudent.name} ã‚’è¨˜éŒ²`);
        }

        function renderLogs() {
            const list = document.getElementById('live-log-list');
            const empty = document.getElementById('empty-log-msg');
            const current = state.logs.filter(l => l.classId == state.selectedClassId).sort((a,b) => b.id - a.id);
            
            if (current.length > 0) {
                empty.classList.add('hidden');
                list.innerHTML = current.map(l => `
                    <div class="log-enter bg-gray-50 p-3 rounded-2xl border flex justify-between items-center group">
                        <div>
                            <div class="text-[8px] font-black text-indigo-400 uppercase tracking-widest">${l.time}</div>
                            <div class="text-[11px] font-black text-gray-800">${l.name}</div>
                            <div class="text-[10px] font-bold text-indigo-600">${l.action}</div>
                        </div>
                        <button onclick="deleteLog(${l.id})" class="text-rose-300 hover:text-rose-600 opacity-0 group-hover:opacity-100 transition px-2 font-bold">âœ•</button>
                    </div>
                `).join('');
            } else {
                empty.classList.remove('hidden');
                list.innerHTML = '';
            }
        }

        function deleteLog(id) {
            state.logs = state.logs.filter(l => l.id != id);
            localStorage.setItem(`${appId}_logs`, JSON.stringify(state.logs));
            renderLogs();
        }

        function closeModal() { document.getElementById('eval-modal').classList.add('hidden'); }

        // --- Settings & Utils ---
        function renderSettings() {
            const list = document.getElementById('time-config-list');
            list.innerHTML = state.timeConfig.map(p => `
                <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl">
                    <span class="text-[10px] font-black w-16 text-gray-400 uppercase">${p.label}</span>
                    <input type="time" value="${p.start}" onchange="updateTime(${p.id}, 'start', this.value)" class="text-xs border-none bg-white p-2 rounded-lg font-bold">
                    <span class="text-gray-300">â€”</span>
                    <input type="time" value="${p.end}" onchange="updateTime(${p.id}, 'end', this.value)" class="text-xs border-none bg-white p-2 rounded-lg font-bold">
                </div>
            `).join('');
        }

        function updateTime(id, key, val) {
            state.timeConfig = state.timeConfig.map(p => p.id == id ? {...p, [key]: val} : p);
            localStorage.setItem(`${appId}_timeConfig`, JSON.stringify(state.timeConfig));
        }

        function renderScheduleList() {
            const list = document.getElementById('all-schedule-list');
            list.innerHTML = state.schedules.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => `
                <div class="bg-white p-4 rounded-2xl border flex justify-between items-center group shadow-sm">
                    <div>
                        <div class="text-[9px] text-gray-400 font-bold">${s.date} | ${state.timeConfig.find(p => p.id == s.periodId)?.label || ''}</div>
                        <div class="text-sm font-black text-gray-800">${s.className}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSchedule('${s.id}')" class="text-indigo-600 text-[10px] font-black bg-indigo-50 px-4 py-2 rounded-xl hover:bg-indigo-600 hover:text-white transition-all">ç·¨é›†</button>
                        <button onclick="deleteSchedule('${s.id}')" class="text-rose-400 text-[10px] font-black bg-rose-50 px-4 py-2 rounded-xl hover:bg-rose-500 hover:text-white transition-all">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
            
            const sel = document.getElementById('input-period');
            if (sel.options.length === 0) {
                state.timeConfig.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.innerText = p.label;
                    sel.appendChild(opt);
                });
            }
        }

        function editSchedule(id) {
            const s = state.schedules.find(item => item.id == id);
            document.getElementById('edit-id').value = s.id;
            document.getElementById('input-date').value = s.date;
            document.getElementById('input-period').value = s.periodId;
            document.getElementById('input-class').value = s.className;
            document.getElementById('input-criteria').value = s.criteria;
            state.currentAiPoints = s.aiPoints;
            const list = document.getElementById('ai-points-list');
            document.getElementById('ai-placeholder').classList.add('hidden');
            list.innerHTML = s.aiPoints.map(p => `<li>${p}</li>`).join('');
            document.getElementById('save-btn').innerText = "æ›´æ–°ã™ã‚‹";
            window.scrollTo(0, 0);
        }

        function deleteSchedule(id) {
            if (!confirm("äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            state.schedules = state.schedules.filter(s => s.id != id);
            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            renderScheduleList();
            renderDashboard();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('opacity-100', 'translate-y-4');
            setTimeout(() => t.classList.remove('opacity-100', 'translate-y-4'), 3000);
        }

        window.onload = () => {
            renderDashboard();
            const dateInput = document.getElementById('input-date');
            if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            setInterval(() => {
                document.getElementById('current-time-display').innerText = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            }, 10000);
        };
    </script>
</body>
</html>
