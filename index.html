<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å“¡å‘ã‘æˆæ¥­æ”¯æ´ãƒ»AIè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #4f46e5; }
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .seat { aspect-ratio: 1 / 1; transition: all 0.2s; }
        .seat:hover { transform: scale(1.03); }
        .pulse-now { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .loading-dots:after { content: '...'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    </style>
</head>
<body class="pb-20">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 z-50">
            <button onclick="showPage('dashboard')" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                <span class="text-xl">ğŸ </span><span class="text-xs">ãƒ›ãƒ¼ãƒ </span>
            </button>
            <button onclick="showPage('schedule')" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                <span class="text-xl">ğŸ“…</span><span class="text-xs">äºˆå®šç™»éŒ²</span>
            </button>
            <button onclick="showPage('settings')" class="flex flex-col items-center text-gray-600 hover:text-indigo-600">
                <span class="text-xl">âš™ï¸</span><span class="text-xs">è¨­å®š</span>
            </button>
        </nav>

        <!-- Page: Dashboard -->
        <section id="page-dashboard" class="page active">
            <div class="flex justify-between items-end mb-6">
                <h1 class="text-2xl font-bold text-gray-800">ä»Šæ—¥ã®æˆæ¥­äºˆå®š</h1>
                <p id="current-time-display" class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full"></p>
            </div>
            <div id="dashboard-list" class="space-y-4">
                <!-- Schedule list will appear here -->
            </div>
        </section>

        <!-- Page: Schedule & Criteria Entry -->
        <section id="page-schedule" class="page">
            <h1 class="text-2xl font-bold mb-6">æˆæ¥­äºˆå®šã¨è©•ä¾¡åŸºæº–ã®ç™»éŒ²</h1>
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ—¥ä»˜</label>
                        <input type="date" id="input-date" class="w-full border p-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ ¡æ™‚</label>
                        <select id="input-period" class="w-full border p-2 rounded-lg"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ã‚¯ãƒ©ã‚¹ãƒ»æ•™ç§‘</label>
                    <input type="text" id="input-class" placeholder="1å¹´Açµ„ æ•°å­¦" class="w-full border p-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ•™ç§‘æ›¸ã®è©•ä¾¡åŸºæº–ï¼ˆåŸæ–‡ï¼‰</label>
                    <textarea id="input-criteria" rows="3" class="w-full border p-2 rounded-lg text-sm" placeholder="ä¾‹ï¼šã‚ã‚‹æ•°ãŒæ–¹ç¨‹å¼ã®è§£ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã€èª¬æ˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚"></textarea>
                </div>

                <!-- AI Extraction Section -->
                <div id="ai-section" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-indigo-700">ğŸ” AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆæŠ½å‡º</span>
                        <button onclick="generateAIPoints()" class="bg-indigo-600 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-700 transition">AIä½œæˆ</button>
                    </div>
                    <div id="ai-result-area" class="text-sm text-indigo-900 space-y-1">
                        <p class="text-gray-400 italic">è©•ä¾¡åŸºæº–ã‚’å…¥åŠ›ã—ã¦ã€ŒAIä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                    </div>
                    
                    <!-- Keyword Area for Re-generation -->
                    <div id="keyword-area" class="mt-3 pt-3 border-t border-indigo-200 hidden">
                        <p class="text-[10px] font-bold text-indigo-400 mb-2">æ³¨ç›®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠ/å…¥åŠ›ã—ã¦å†ä½œæˆ</p>
                        <div id="keyword-chips" class="flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="custom-keyword" placeholder="è‡ªç”±å…¥åŠ›..." class="flex-1 text-xs border p-1 rounded">
                            <button onclick="generateAIPoints(true)" class="bg-white border border-indigo-300 text-indigo-600 text-[10px] px-2 py-1 rounded">å†ä½œæˆ</button>
                        </div>
                    </div>
                </div>

                <button onclick="saveSchedule()" id="save-btn" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">ç™»éŒ²ã™ã‚‹</button>
                <button onclick="resetForm()" id="cancel-btn" class="w-full text-gray-400 py-1 text-xs hidden">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæ–°è¦ä½œæˆã«æˆ»ã‚‹ï¼‰</button>
            </div>

            <div class="mt-8">
                <h3 class="font-bold text-gray-700 mb-3 text-sm">ç™»éŒ²æ¸ˆã¿ã®æˆæ¥­</h3>
                <div id="all-schedule-list" class="space-y-2"></div>
            </div>
        </section>

        <!-- Page: Time Settings (Chime) -->
        <section id="page-settings" class="page">
            <h1 class="text-2xl font-bold mb-6">è¨­å®š</h1>
            <div class="bg-white p-6 rounded-2xl shadow-sm border mb-6">
                <h2 class="font-bold text-gray-800 mb-4 flex items-center">ğŸ•’ ãƒãƒ£ã‚¤ãƒ æ™‚åˆ»è¨­å®š</h2>
                <div id="time-config-list" class="space-y-3">
                    <!-- Periods configuration -->
                </div>
            </div>
        </section>

        <!-- Page: Seating Chart -->
        <section id="page-classroom" class="page">
            <div class="flex items-center gap-3 mb-4">
                <button onclick="showPage('dashboard')" class="bg-white p-2 rounded-lg border shadow-sm text-sm">â†</button>
                <div>
                    <h2 id="view-class-title" class="text-xl font-bold"></h2>
                    <p id="view-class-time" class="text-xs text-gray-500"></p>
                </div>
            </div>

            <!-- Reminder Card -->
            <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl mb-6">
                <p class="text-[10px] font-bold text-amber-600 mb-2">ğŸ“¢ æœ¬æ—¥ã®è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆ</p>
                <div id="view-ai-points" class="text-sm font-bold text-amber-900 grid grid-cols-1 gap-1"></div>
            </div>

            <div class="bg-gray-300 p-6 rounded-3xl shadow-inner min-h-[400px]">
                <div class="w-full bg-white/50 py-2 text-center text-xs font-bold text-gray-500 rounded mb-6 border border-dashed border-gray-400">é»’æ¿ / æ•™å“</div>
                <div id="seating-grid" class="grid grid-cols-6 gap-3"></div>
            </div>
        </section>
    </div>

    <!-- Modal: Evaluation -->
    <div id="eval-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center hidden">
        <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl m-4">
            <h3 id="modal-student-name" class="text-xl font-bold mb-4">ç”Ÿå¾’å</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2">ãƒã‚¸ãƒ†ã‚£ãƒ–</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="recordEval('æŒ™æ‰‹ãƒ»ç™ºè¨€', 'pos')" class="bg-green-50 text-green-700 p-2 rounded-xl text-xs border border-green-100">ğŸ™‹ ç™ºè¨€</button>
                        <button onclick="recordEval('ä»–è€…ã¸æ•™ãˆã‚‹', 'pos')" class="bg-green-50 text-green-700 p-2 rounded-xl text-xs border border-green-100">ğŸ¤ ç›¸äº’æŒ‡å°</button>
                        <button onclick="recordEval('é‹­ã„è€ƒå¯Ÿ', 'pos')" class="bg-green-50 text-green-700 p-2 rounded-xl text-xs border border-green-100">ğŸ’¡ é‹­ã„è€ƒå¯Ÿ</button>
                        <button onclick="recordEval('é›†ä¸­ãƒ»ç¶™ç¶š', 'pos')" class="bg-green-50 text-green-700 p-2 rounded-xl text-xs border border-green-100">ğŸ“– é›†ä¸­</button>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2">è¦ãƒ•ã‚©ãƒ­ãƒ¼</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="recordEval('é¨’ãŒã—ã„', 'neg')" class="bg-red-50 text-red-700 p-2 rounded-xl text-xs border border-red-100">ğŸ“¢ é¨’ãŒã—ã„</button>
                        <button onclick="recordEval('æˆæ¥­ä¸­æ–­', 'neg')" class="bg-red-50 text-red-700 p-2 rounded-xl text-xs border border-red-100">âš ï¸ ä¸­æ–­è¡Œç‚º</button>
                        <button onclick="recordEval('å±…çœ ã‚Š', 'neg')" class="bg-red-50 text-red-700 p-2 rounded-xl text-xs border border-red-100">ğŸ˜´ å±…çœ ã‚Š</button>
                        <button onclick="recordEval('é“å…·å¿˜ã‚Œ', 'neg')" class="bg-red-50 text-red-700 p-2 rounded-xl text-xs border border-red-100">ğŸ’ å¿˜ã‚Œç‰©</button>
                    </div>
                </div>
            </div>
            <button onclick="closeModal()" class="w-full mt-6 py-2 text-gray-400 text-sm">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 transition-opacity z-[200] pointer-events-none"></div>

    <script>
        // --- åˆæœŸè¨­å®š & ãƒ‡ãƒ¼ã‚¿ ---
        const apiKey = ""; // å®Ÿè¡Œç’°å¢ƒã‹ã‚‰è‡ªå‹•ä¾›çµ¦
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edu-support-tool';

        let state = {
            schedules: JSON.parse(localStorage.getItem(`${appId}_schedules`)) || [],
            timeConfig: JSON.parse(localStorage.getItem(`${appId}_timeConfig`)) || [
                { id: 1, label: "1æ ¡æ™‚", start: "08:50", end: "09:40" },
                { id: 2, label: "2æ ¡æ™‚", start: "09:50", end: "10:40" },
                { id: 3, label: "3æ ¡æ™‚", start: "10:50", end: "11:40" },
                { id: 4, label: "4æ ¡æ™‚", start: "11:50", end: "12:40" },
                { id: 5, label: "5æ ¡æ™‚", start: "13:30", end: "14:20" },
                { id: 6, label: "6æ ¡æ™‚", start: "14:30", end: "15:20" }
            ],
            logs: JSON.parse(localStorage.getItem(`${appId}_logs`)) || [],
            currentAiPoints: [],
            currentKeywords: [],
            selectedStudent: null,
            selectedClassId: null
        };

        // --- ç”»é¢ç®¡ç† ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            window.scrollTo(0, 0);
            
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'schedule') renderScheduleEntry();
            if (pageId === 'settings') renderSettings();
        }

        // --- AIæ©Ÿèƒ½ ---
        async function generateAIPoints(isRegen = false) {
            const criteria = document.getElementById('input-criteria').value;
            if (!criteria) return showToast("è©•ä¾¡åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const resultArea = document.getElementById('ai-result-area');
            resultArea.innerHTML = '<p class="loading-dots text-indigo-400 font-bold">AIãŒåˆ†æä¸­</p>';

            let prompt = `ä»¥ä¸‹ã®è©•ä¾¡åŸºæº–ã‹ã‚‰ã€æˆæ¥­ä¸­ã«æ•™å“¡ãŒæœºé–“æŒ‡å°ã§ã€Œè¦³å¯Ÿã™ã¹ãç”Ÿå¾’ã®å…·ä½“çš„è¡Œå‹•ç›®å®‰ã€ã‚’3ã¤æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
            ã€æ¡ä»¶ã€‘
            ãƒ»1ã¤20æ–‡å­—ä»¥å†…
            ãƒ»ã€Œãƒ»ã€œã—ã¦ã„ã‚‹ã€ã®å½¢å¼ã®ã¿
            ãƒ»è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã€‚çµæœã®3è¡Œã®ã¿å‡ºåŠ›ã€‚
            
            è©•ä¾¡åŸºæº–: ${criteria}`;

            if (isRegen) {
                const custom = document.getElementById('custom-keyword').value;
                const chips = Array.from(document.querySelectorAll('.keyword-chip.active')).map(c => c.innerText);
                prompt += `\nç‰¹ã«ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é‡è¦–ã—ã¦ä½œæˆã—ã¦ãã ã•ã„: ${chips.join(', ')} ${custom}`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ãƒ»è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
                
                state.currentAiPoints = text.split('\n').filter(l => l.trim().startsWith('ãƒ»')).slice(0, 3);
                
                renderAIResults();
                extractKeywords(criteria); // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å€™è£œã‚‚æŠ½å‡º
            } catch (e) {
                resultArea.innerHTML = '<p class="text-red-500">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        async function extractKeywords(text) {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼šå®Ÿéš›ã¯Geminiã§è¡Œã†æ–¹ãŒç²¾åº¦é«˜ã„ãŒã€ã“ã“ã§ã¯ä¸»è¦èªå¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            const prompt = `ä»¥ä¸‹ã®æ–‡ç« ã‹ã‚‰ã€æ•™è‚²ã«ãŠã„ã¦é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’4ã¤çŸ­ãæŠ½å‡ºã—ã¦ãã ã•ã„ã€‚ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å›ç­”ã®ã¿ã€‚: ${text}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const kwText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                state.currentKeywords = kwText.split(/[,ã€]/).map(k => k.trim()).filter(k => k);
                renderKeywords();
            } catch (e) {}
        }

        function renderAIResults() {
            const area = document.getElementById('ai-result-area');
            area.innerHTML = state.currentAiPoints.map(p => `<div class="font-bold">âœ… ${p}</div>`).join('');
            document.getElementById('keyword-area').classList.remove('hidden');
        }

        function renderKeywords() {
            const container = document.getElementById('keyword-chips');
            container.innerHTML = state.currentKeywords.map(k => `
                <button onclick="this.classList.toggle('active'); this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white');" 
                        class="keyword-chip border border-indigo-200 px-2 py-1 rounded-full text-[10px] text-indigo-500">
                    ${k}
                </button>
            `).join('');
        }

        // --- äºˆå®šç®¡ç† ---
        function saveSchedule() {
            const date = document.getElementById('input-date').value;
            const periodId = document.getElementById('input-period').value;
            const className = document.getElementById('input-class').value;
            const criteria = document.getElementById('input-criteria').value;
            const editId = document.getElementById('edit-id').value;

            if (!date || !className || !criteria) return showToast("å…¨é …ç›®å…¥åŠ›ã—ã¦ãã ã•ã„");

            const period = state.timeConfig.find(p => p.id == periodId);
            const entry = {
                id: editId ? parseInt(editId) : Date.now(),
                date,
                periodId,
                periodLabel: period.label,
                className,
                criteria,
                aiPoints: state.currentAiPoints
            };

            if (editId) {
                state.schedules = state.schedules.map(s => s.id == editId ? entry : s);
            } else {
                state.schedules.push(entry);
            }

            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            showToast(editId ? "æ›´æ–°ã—ã¾ã—ãŸ" : "ç™»éŒ²ã—ã¾ã—ãŸ");
            resetForm();
            showPage('dashboard');
        }

        function editSchedule(id) {
            const s = state.schedules.find(item => item.id == id);
            if (!s) return;

            document.getElementById('edit-id').value = s.id;
            document.getElementById('input-date').value = s.date;
            document.getElementById('input-period').value = s.periodId;
            document.getElementById('input-class').value = s.className;
            document.getElementById('input-criteria').value = s.criteria;
            state.currentAiPoints = s.aiPoints || [];
            
            renderAIResults();
            document.getElementById('save-btn').innerText = "æ›´æ–°ã™ã‚‹";
            document.getElementById('cancel-btn').classList.remove('hidden');
            showPage('schedule');
        }

        function deleteSchedule(id) {
            if (!confirm("ã“ã®æˆæ¥­äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            state.schedules = state.schedules.filter(s => s.id != id);
            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            renderDashboard();
            renderScheduleEntry();
        }

        function resetForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('input-class').value = '';
            document.getElementById('input-criteria').value = '';
            document.getElementById('ai-result-area').innerHTML = '<p class="text-gray-400 italic">è©•ä¾¡åŸºæº–ã‚’å…¥åŠ›ã—ã¦ã€ŒAIä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
            document.getElementById('keyword-area').classList.add('hidden');
            document.getElementById('save-btn').innerText = "ç™»éŒ²ã™ã‚‹";
            document.getElementById('cancel-btn').classList.add('hidden');
            state.currentAiPoints = [];
        }

        // --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”» ---
        function renderDashboard() {
            const list = document.getElementById('dashboard-list');
            list.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('current-time-display').innerText = `ç¾åœ¨: ${currentTime}`;

            // ä»Šæ—¥ã®äºˆå®šã‚’ã‚½ãƒ¼ãƒˆ
            const todaySchedules = state.schedules
                .filter(s => s.date === today)
                .sort((a, b) => a.periodId - b.periodId);

            if (todaySchedules.length === 0) {
                list.innerHTML = `
                    <div class="bg-white p-10 rounded-2xl text-center border border-dashed">
                        <p class="text-gray-400 mb-2">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        <button onclick="showPage('schedule')" class="text-indigo-600 font-bold">äºˆå®šã‚’ç™»éŒ²ã™ã‚‹</button>
                    </div>
                `;
                return;
            }

            todaySchedules.forEach(s => {
                const config = state.timeConfig.find(p => p.id == s.periodId);
                const isNow = currentTime >= config.start && currentTime <= config.end;
                
                // 1æ™‚é–“å‰ã‹ã©ã†ã‹
                const [startH, startM] = config.start.split(':').map(Number);
                const startTimeDate = new Date();
                startTimeDate.setHours(startH, startM, 0);
                const diffMin = (startTimeDate - now) / 60000;
                const isSoon = diffMin > 0 && diffMin <= 60;

                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-2xl border-2 transition-all cursor-pointer ${isNow ? 'border-indigo-500 shadow-lg' : 'border-transparent shadow-sm'}`;
                card.onclick = () => openClassroom(s);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">${s.periodLabel}</span>
                            <span class="text-xs font-medium text-gray-400">${config.start} ~ ${config.end}</span>
                        </div>
                        ${isNow ? '<span class="text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full pulse-now">æˆæ¥­ä¸­</span>' : ''}
                        ${isSoon ? '<span class="text-[10px] font-bold text-white bg-amber-500 px-2 py-0.5 rounded-full">ã¾ã‚‚ãªãï¼</span>' : ''}
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">${s.className}</h3>
                    <div class="mt-3 bg-gray-50 p-2 rounded-lg">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ</p>
                        <div class="text-xs text-indigo-700 font-medium">${(s.aiPoints || []).join(' / ')}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- è¨­å®šç”»é¢æç”» ---
        function renderSettings() {
            const list = document.getElementById('time-config-list');
            list.innerHTML = '';
            state.timeConfig.forEach(p => {
                const item = document.createElement('div');
                item.className = "flex items-center gap-3 bg-gray-50 p-3 rounded-xl";
                item.innerHTML = `
                    <span class="text-sm font-bold w-12 text-gray-500">${p.label}</span>
                    <input type="time" value="${p.start}" onchange="updateTime(${p.id}, 'start', this.value)" class="flex-1 border p-1 rounded-lg text-sm">
                    <span class="text-gray-400">~</span>
                    <input type="time" value="${p.end}" onchange="updateTime(${p.id}, 'end', this.value)" class="flex-1 border p-1 rounded-lg text-sm">
                `;
                list.appendChild(item);
            });
        }

        function updateTime(id, key, val) {
            state.timeConfig = state.timeConfig.map(p => p.id == id ? { ...p, [key]: val } : p);
            localStorage.setItem(`${appId}_timeConfig`, JSON.stringify(state.timeConfig));
        }

        function renderScheduleEntry() {
            const list = document.getElementById('all-schedule-list');
            list.innerHTML = '';
            
            const periods = document.getElementById('input-period');
            if (periods.children.length === 0) {
                state.timeConfig.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = p.label;
                    periods.appendChild(opt);
                });
            }

            state.schedules.sort((a, b) => new Date(a.date) - new Date(b.date) || a.periodId - b.periodId).forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border text-sm flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <span class="text-[10px] font-bold text-gray-400">${s.date} ${s.periodLabel}</span>
                        <div class="font-bold">${s.className}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSchedule(${s.id})" class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs">ç·¨é›†</button>
                        <button onclick="deleteSchedule(${s.id})" class="text-red-500 bg-red-50 px-2 py-1 rounded text-xs">å‰Šé™¤</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- åº§å¸­è¡¨ & è©•ä¾¡ ---
        function openClassroom(s) {
            state.selectedClassId = s.id;
            document.getElementById('view-class-title').innerText = s.className;
            const config = state.timeConfig.find(p => p.id == s.periodId);
            document.getElementById('view-class-time').innerText = `${s.periodLabel} (${config.start} - ${config.end})`;
            
            const aiArea = document.getElementById('view-ai-points');
            aiArea.innerHTML = (s.aiPoints || ["ãƒ»è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"]).map(p => `<div>âœ… ${p}</div>`).join('');
            
            renderSeats();
            showPage('classroom');
        }

        function renderSeats() {
            const grid = document.getElementById('seating-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 30; i++) {
                const student = { id: i, name: `ç”Ÿå¾’ ${String.fromCharCode(64 + i)}` };
                const seat = document.createElement('div');
                
                // ç›´è¿‘ã®è©•ä¾¡ç¢ºèª
                const studentLogs = state.logs.filter(l => l.studentId === i && l.classId === state.selectedClassId);
                const last = studentLogs[studentLogs.length - 1];
                let colorClass = "bg-white border-gray-200";
                if(last) colorClass = last.type === 'pos' ? "bg-green-100 border-green-300" : "bg-red-100 border-red-300 text-red-900";

                seat.className = `seat ${colorClass} border-2 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer shadow-sm`;
                seat.onclick = () => {
                    state.selectedStudent = student;
                    document.getElementById('modal-student-name').innerText = student.name;
                    document.getElementById('eval-modal').classList.remove('hidden');
                };
                seat.innerHTML = `
                    <span class="text-[8px] text-gray-400 mb-1">${i}</span>
                    <span class="text-[10px] font-bold truncate w-full text-center">${student.name}</span>
                `;
                grid.appendChild(seat);
            }
        }

        function closeModal() {
            document.getElementById('eval-modal').classList.add('hidden');
        }

        function recordEval(action, type) {
            const entry = {
                id: Date.now(),
                classId: state.selectedClassId,
                studentId: state.selectedStudent.id,
                action,
                type,
                time: new Date().toISOString()
            };
            state.logs.push(entry);
            localStorage.setItem(`${appId}_logs`, JSON.stringify(state.logs));
            
            closeModal();
            renderSeats();
            showToast(`${state.selectedStudent.name}: ${action}ã‚’è¨˜éŒ²`);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        }

        // åˆæœŸåŒ–
        window.onload = () => {
            renderDashboard();
            setInterval(renderDashboard, 60000); // 1åˆ†æ¯ã«ç¾åœ¨æ™‚åˆ»ã‚’åæ˜ 
        };
    </script>
</body>
</html>
