<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パステル・ティーチャー・ログ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --pastel-green: #f1f8e9;
            --light-green: #dcedc8;
            --accent-green: #81c784;
            --text-main: #33691e;
        }
        body {
            background-color: var(--pastel-green);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            margin: 0;
            padding-bottom: 100px;
            min-height: 100vh;
        }
        /* 大画面対応 */
        .max-w-custom { max-width: 1200px; }
        
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 24px;
        }
        .tab-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 11px;
            color: #777;
            cursor: pointer;
            transition: color 0.3s;
        }
        .tab-item.active { color: var(--accent-green); font-weight: bold; }
        
        .btn {
            background-color: var(--light-green);
            color: var(--text-main);
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background-color: var(--accent-green); color: white; transform: translateY(-1px); }
        .btn-outline { border: 2px solid var(--light-green); background: transparent; }
        
        .seat {
            width: 100px;
            height: 75px;
            border: 2px solid var(--light-green);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            cursor: pointer;
            position: relative;
            background: white;
            transition: all 0.2s;
        }
        .seat.empty { background-color: #f9f9f9; border-color: #eee; color: #ccc; }
        .seat:hover { border-color: var(--accent-green); background: var(--pastel-green); }
        
        .time-display {
            position: fixed;
            top: 15px; right: 25px;
            font-weight: bold;
            font-size: 16px;
            background: white;
            padding: 8px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1100;
        }
        .keyword-chip {
            display: inline-block;
            padding: 6px 14px;
            margin: 4px;
            border-radius: 20px;
            background: #f0f4f0;
            cursor: pointer;
            font-size: 14px;
            border: 1px solid transparent;
        }
        .keyword-chip.selected {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 600px;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--light-green); border-radius: 10px; }
    </style>
</head>
<body>

<div id="currentTime" class="time-display"></div>

<div id="app" class="max-w-custom mx-auto p-6 pt-16">
    
    <!-- HOME -->
    <div id="section-home" class="section">
        <h1 class="text-3xl font-bold mb-8">授業ログ・ダッシュボード</h1>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-green-400 rounded-full"></span>本日の授業予定
                </h2>
                <div id="today-plans" class="space-y-4"></div>
                
                <h2 class="text-xl font-bold mt-12 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-gray-300 rounded-full"></span>今後の予定
                </h2>
                <div id="future-plans" class="space-y-4"></div>
            </div>
            <div>
                <div class="card bg-gradient-to-br from-white to-green-50">
                    <h3 class="font-bold mb-4">AIステータス</h3>
                    <p class="text-xs text-gray-500 mb-4">AI機能が反応しない場合は、以下のボタンで接続をリフレッシュしてください。</p>
                    <button class="btn btn-outline w-full text-sm" onclick="refreshAIConnection()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        AI接続リフレッシュ
                    </button>
                    <div id="ai-debug-info" class="mt-2 text-[10px] text-gray-400 hidden">API Key is ready.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PLAN -->
    <div id="section-plan" class="section hidden">
        <h1 class="text-3xl font-bold mb-8">授業計画・評価基準の登録</h1>
        <div class="card">
            <div class="mb-6">
                <label class="block mb-3 font-bold text-lg">教科書の評価基準（貼り付け）</label>
                <textarea id="raw-criteria" class="w-full h-48 p-4 border-2 border-gray-100 rounded-2xl focus:border-green-300 outline-none transition-all text-lg" placeholder="例：ある数が方程式の解であるかどうかを判断する方法を考え、説明することができる。"></textarea>
            </div>
            
            <div class="flex gap-4 mb-8">
                <button id="btn-generate" class="btn shadow-md" onclick="generateObservationPoints()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 110-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd" /></svg>
                    AIで観察ポイントを抽出
                </button>
            </div>

            <div id="ai-output-area" class="hidden animate-fade-in">
                <div class="p-6 bg-green-50 border-2 border-green-100 rounded-2xl mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-green-800">AI抽出：授業中の観察ポイント目安</h3>
                        <button class="text-xs text-green-600 font-bold hover:underline" onclick="generateObservationPoints()">再生成</button>
                    </div>
                    <ul id="observation-list" class="space-y-3 mb-6 text-lg"></ul>
                    
                    <div class="border-t border-green-200 pt-6">
                        <p class="text-sm font-bold text-green-700 mb-3">キーワードの調整・追加</p>
                        <div id="extracted-keywords" class="flex flex-wrap mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="manual-keyword" class="flex-1 p-3 border rounded-xl" placeholder="先生が特に注目したいポイントを入力...">
                            <button class="btn btn-outline" onclick="regenerateObservationPoints()">
                                キーワードを反映して再作成
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 p-6 bg-gray-50 rounded-2xl">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">実施月</label>
                    <select id="plan-month" class="w-full p-3 border rounded-xl bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">実施日</label>
                    <select id="plan-day" class="w-full p-3 border rounded-xl bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">時間割</label>
                    <select id="plan-period" class="w-full p-3 border rounded-xl bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">対象クラス・座席表</label>
                    <select id="plan-layout" class="w-full p-3 border rounded-xl bg-white"></select>
                </div>
            </div>
            
            <button class="btn w-full mt-8 py-4 text-xl shadow-lg" onclick="savePlan()">
                この授業計画を保存する
            </button>
        </div>
    </div>

    <!-- HISTORY (LIST) -->
    <div id="section-history" class="section hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">授業計画ライブラリ</h1>
            <button class="btn" onclick="exportEvaluationHistory()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                CSVダウンロード (全データ)
            </button>
        </div>
        <div id="class-tabs" class="flex overflow-x-auto gap-3 mb-6 pb-2"></div>
        <div id="plans-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <!-- SEATS -->
    <div id="section-seats" class="section hidden">
        <h1 class="text-3xl font-bold mb-8">座席表の管理</h1>
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <div class="card">
                <h2 class="font-bold mb-6 text-xl">新規作成・基本設定</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">座席表の名前</label>
                        <input type="text" id="seat-layout-name" class="w-full p-3 border rounded-xl" placeholder="例：3年B組 数学用">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">横の列数</label>
                            <input type="number" id="seat-cols" class="w-full p-3 border rounded-xl" value="6" oninput="updateSeatPreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">縦の行数</label>
                            <input type="number" id="seat-rows" class="w-full p-3 border rounded-xl" value="5" oninput="updateSeatPreview()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">生徒の総人数</label>
                        <input type="number" id="seat-total-count" class="w-full p-3 border rounded-xl" value="30">
                        <p id="seat-total-calc" class="text-[10px] text-gray-400 mt-1"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">生徒名を入力（改行区切り）</label>
                        <textarea id="seat-student-names" class="w-full h-48 p-3 text-sm border rounded-xl" placeholder="田中&#10;佐藤&#10;鈴木..." oninput="updateSeatPreview()"></textarea>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button class="btn flex-1" onclick="saveSeatLayout()">保存・登録</button>
                        <button class="btn btn-outline" onclick="resetSeatForm()">クリア</button>
                    </div>
                </div>
                
                <h3 class="font-bold mt-10 mb-4 text-gray-400 uppercase text-xs">保存済みの座席表</h3>
                <div id="saved-layouts-list" class="space-y-2"></div>
            </div>

            <div class="xl:col-span-2">
                <div class="card h-full">
                    <h2 class="font-bold mb-2 text-xl">座席プレビュー・編集</h2>
                    <p class="text-sm text-gray-500 mb-6">座席をドラッグして入れ替えることができます。名前は左上から自動配置されます。</p>
                    <div id="seat-preview-container" class="bg-gray-50 rounded-2xl p-8 flex justify-center items-start min-h-[500px] overflow-auto border-2 border-dashed border-gray-200">
                        <!-- Preview Grid -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="section-settings" class="section hidden">
        <h1 class="text-3xl font-bold mb-8">カスタマイズ設定</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="card">
                <h3 class="font-bold mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    時間割（時限）の設定
                </h3>
                <div id="period-settings-list" class="space-y-3 mb-6"></div>
                <button class="btn btn-outline w-full" onclick="addPeriodSetting()">＋ 新しい時限を追加</button>
            </div>
            
            <div class="card">
                <h3 class="font-bold mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    評価アクションの編集
                </h3>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm font-bold text-green-700 mb-3">ポジティブな行動 (+)</p>
                        <div id="positive-actions" class="space-y-2"></div>
                        <button class="text-xs text-green-600 mt-2 font-bold" onclick="addAction('positive')">＋ 追加する</button>
                    </div>
                    <div class="border-t pt-6">
                        <p class="text-sm font-bold text-red-700 mb-3">要指導・気になる行動 (-)</p>
                        <div id="negative-actions" class="space-y-2"></div>
                        <button class="text-xs text-red-600 mt-2 font-bold" onclick="addAction('negative')">＋ 追加する</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EVALUATE (RUNNING) -->
    <div id="section-evaluate" class="section hidden">
        <div class="flex justify-between items-center mb-6">
            <button class="btn btn-outline" onclick="navigate('home')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                ダッシュボードに戻る
            </button>
            <div class="text-center">
                <h2 id="eval-header" class="text-2xl font-bold"></h2>
                <p id="eval-sub-header" class="text-sm text-gray-500"></p>
            </div>
            <button class="btn" onclick="exportEvaluationHistory()">記録を出力</button>
        </div>
        
        <div id="eval-criteria-reminder" class="card bg-green-50 border-2 border-green-200 py-6 mb-8">
            <div class="max-w-3xl mx-auto">
                <p class="text-xs font-bold text-green-600 mb-2 text-center uppercase tracking-widest">本日の注目ポイント</p>
                <div id="eval-points-display" class="flex flex-col md:flex-row justify-center gap-6 text-center text-lg font-bold text-green-900"></div>
            </div>
        </div>

        <div id="eval-seat-grid-container" class="bg-white rounded-3xl p-10 shadow-inner overflow-auto flex justify-center min-h-[600px]">
            <div id="eval-seat-grid"></div>
        </div>
    </div>
</div>

<!-- BOTTOM TABS -->
<div class="tab-bar">
    <div class="tab-item active" onclick="navigate('home')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
        <span>ホーム</span>
    </div>
    <div class="tab-item" onclick="navigate('plan')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>計画作成</span>
    </div>
    <div class="tab-item" onclick="navigate('history')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
        <span>一覧</span>
    </div>
    <div class="tab-item" onclick="navigate('seats')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
        <span>座席表</span>
    </div>
    <div class="tab-item" onclick="navigate('settings')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        <span>設定</span>
    </div>
</div>

<!-- ACTION MODAL -->
<div id="action-modal" class="modal" onclick="if(event.target==this) closeModal()">
    <div class="modal-content animate-pop">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 id="modal-student-name" class="text-3xl font-bold">生徒名</h3>
                <p class="text-xs text-gray-400 mt-1">評価アクションを選択してください</p>
            </div>
            <button class="text-gray-300 hover:text-gray-600" onclick="closeModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l18 18" /></svg>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <p class="text-sm font-bold text-green-700 mb-4 border-b-2 border-green-100 pb-2">良い行動 (+)</p>
                <div id="modal-pos-actions" class="grid grid-cols-1 gap-3"></div>
            </div>
            <div>
                <p class="text-sm font-bold text-red-700 mb-4 border-b-2 border-red-100 pb-2">あまり良くない行動 (-)</p>
                <div id="modal-neg-actions" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>
        <button class="btn w-full mt-10 bg-gray-100 text-gray-500 hover:bg-gray-200" onclick="closeModal()">キャンセル</button>
    </div>
</div>

<script>
    // --- APP STATE ---
    let apiKey = ""; // Runtime provides this
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'teacher-pro-app';

    let state = {
        plans: [],
        seatLayouts: [],
        periodSettings: [
            { id: 1, label: '1時間目', start: '08:50', end: '09:40' },
            { id: 2, label: '2時間目', start: '09:50', end: '10:40' },
            { id: 3, label: '3時間目', start: '10:50', end: '11:40' },
            { id: 4, label: '4時間目', start: '11:50', end: '12:40' },
            { id: 5, label: '5時間目', start: '13:30', end: '14:20' }
        ],
        actions: {
            positive: ['発言した', '他者に教えた', '良い着眼点', '集中している', 'ノートが丁寧'],
            negative: ['騒がしい', '授業中断', '居眠り', '忘れ物', '離席']
        },
        evaluations: [],
        tempKeywords: [],
        selectedKeywords: []
    };

    // --- UTILS & STORAGE ---
    function saveToStorage() {
        localStorage.setItem(`app_${appId}_state`, JSON.stringify(state));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem(`app_${appId}_state`);
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
        }
        initUI();
    }

    // --- UI INITIALIZATION ---
    function initUI() {
        updateTime();
        setInterval(updateTime, 1000);
        
        // Populate Selects
        const mSelect = document.getElementById('plan-month');
        const dSelect = document.getElementById('plan-day');
        for(let i=1; i<=12; i++) mSelect.add(new Option(i + '月', i));
        for(let i=1; i<=31; i++) dSelect.add(new Option(i + '日', i));
        const now = new Date();
        mSelect.value = now.getMonth() + 1;
        dSelect.value = now.getDate();

        renderPeriodSettings();
        renderLayoutOptions();
        renderActionSettings();
        renderHome();
        renderPlansList();
        renderLayoutsList();
        updateSeatPreview();
    }

    function updateTime() {
        const now = new Date();
        document.getElementById('currentTime').innerText = now.toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        
        // Auto-switch today's plans on day change
        if (now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) {
            renderHome();
        }
    }

    function navigate(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('section-' + sectionId).classList.remove('hidden');
        
        document.querySelectorAll('.tab-item').forEach((item, idx) => {
            const sections = ['home', 'plan', 'history', 'seats', 'settings'];
            item.classList.toggle('active', sections[idx] === sectionId);
        });

        if (sectionId === 'home') renderHome();
        if (sectionId === 'history') renderPlansList();
        window.scrollTo(0,0);
    }

    // --- AI STABILITY FEATURE ---
    function refreshAIConnection() {
        // In this environment, the key is provided at runtime.
        // We reset some internal flags if needed.
        const debug = document.getElementById('ai-debug-info');
        debug.classList.remove('hidden');
        debug.innerText = `リフレッシュ完了: ${new Date().toLocaleTimeString()} - 接続準備OK`;
        setTimeout(() => debug.classList.add('hidden'), 3000);
    }

    async function callGemini(prompt) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // Exponential Backoff Implementation
        const maxRetries = 5;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.candidates) return data.candidates[0].content.parts[0].text;
                throw new Error("Invalid response");
            } catch (err) {
                if (i === maxRetries - 1) throw err;
                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
            }
        }
    }

    async function generateObservationPoints() {
        const criteria = document.getElementById('raw-criteria').value;
        if (!criteria) return alert("基準を入力してください");

        const btn = document.getElementById('btn-generate');
        const originalText = btn.innerHTML;
        btn.innerText = "AIが分析中...";
        btn.disabled = true;

        try {
            const prompt = `以下の評価基準から、授業中に観察すべき行動目安を3つ抽出してください。
基準：${criteria}
制約：
・「・〜している」の形式で出力。
・1つ20文字以内。
・余計な解説、導入文、結びは一切禁止。箇条書きのみ。`;

            const result = await callGemini(prompt);
            const points = result.split('\n').filter(l => l.trim().startsWith('・')).slice(0, 3);
            
            const kwPrompt = `以下の文章から、教育的なキーワードを5つ程度抽出してください。カンマ区切りでキーワードのみ出力してください。
文章：${criteria}`;
            const kwResult = await callGemini(kwPrompt);
            state.tempKeywords = kwResult.split(',').map(s => s.trim());
            state.selectedKeywords = [];

            displayObservationPoints(points);
            renderKeywords();
        } catch (e) {
            alert("AIの呼び出しに失敗しました。接続リフレッシュを試してください。");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function displayObservationPoints(points) {
        const area = document.getElementById('ai-output-area');
        const list = document.getElementById('observation-list');
        area.classList.remove('hidden');
        list.innerHTML = points.map(p => `<li class="flex items-center gap-2"><span class="w-2 h-2 bg-green-400 rounded-full"></span>${p.replace('・','')}</li>`).join('');
    }

    function renderKeywords() {
        const container = document.getElementById('extracted-keywords');
        container.innerHTML = state.tempKeywords.map(kw => `
            <span class="keyword-chip ${state.selectedKeywords.includes(kw) ? 'selected' : ''}" onclick="toggleKeyword('${kw}')">${kw}</span>
        `).join('');
    }

    function toggleKeyword(kw) {
        if (state.selectedKeywords.includes(kw)) {
            state.selectedKeywords = state.selectedKeywords.filter(k => k !== kw);
        } else {
            state.selectedKeywords.push(kw);
        }
        renderKeywords();
    }

    async function regenerateObservationPoints() {
        const criteria = document.getElementById('raw-criteria').value;
        const manual = document.getElementById('manual-keyword').value;
        const keywords = [...state.selectedKeywords];
        if (manual) keywords.push(manual);

        const prompt = `以下の評価基準と重点キーワードをもとに、授業中に観察すべき行動目安を3つ抽出してください。
基準：${criteria}
重点：${keywords.join(', ')}
制約：
・「・〜している」の形式で出力。
・1つ20文字以内。
・余計な解説は禁止。`;

        const result = await callGemini(prompt);
        const points = result.split('\n').filter(l => l.trim().startsWith('・')).slice(0, 3);
        displayObservationPoints(points);
    }

    // --- SEAT LAYOUT LOGIC ---
    function updateSeatPreview() {
        const cols = parseInt(document.getElementById('seat-cols').value) || 1;
        const rows = parseInt(document.getElementById('seat-rows').value) || 1;
        const namesText = document.getElementById('seat-student-names').value;
        const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
        
        document.getElementById('seat-total-calc').innerText = `最大収容: ${cols * rows}名 (現在 ${names.length}名入力済)`;
        
        const container = document.getElementById('seat-preview-container');
        container.innerHTML = '';
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = `repeat(${cols}, 100px)`;
        grid.style.gap = '15px';

        for (let i = 0; i < rows * cols; i++) {
            const name = names[i] || "";
            const seat = document.createElement('div');
            seat.className = `seat ${!name ? 'empty' : ''}`;
            seat.draggable = !!name;
            seat.innerHTML = `<span>${name || (i+1)}</span>`;
            
            seat.ondragstart = (e) => e.dataTransfer.setData('text/plain', i);
            seat.ondragover = (e) => e.preventDefault();
            seat.ondrop = (e) => {
                const fromIdx = e.dataTransfer.getData('text/plain');
                swapStudentNames(fromIdx, i);
            };
            
            grid.appendChild(seat);
        }
        container.appendChild(grid);
    }

    function swapStudentNames(idx1, idx2) {
        const textarea = document.getElementById('seat-student-names');
        const names = textarea.value.split('\n');
        // Ensure array is long enough
        const max = Math.max(idx1, idx2);
        while(names.length <= max) names.push("");
        
        const temp = names[idx1];
        names[idx1] = names[idx2];
        names[idx2] = temp;
        textarea.value = names.join('\n');
        updateSeatPreview();
    }

    function saveSeatLayout() {
        const name = document.getElementById('seat-layout-name').value;
        if (!name) return alert("座席表名を入力してください");

        const layout = {
            id: 'layout_' + Date.now(),
            name: name,
            cols: parseInt(document.getElementById('seat-cols').value),
            rows: parseInt(document.getElementById('seat-rows').value),
            studentCount: parseInt(document.getElementById('seat-total-count').value),
            names: document.getElementById('seat-student-names').value.split('\n')
        };

        const existingIdx = state.seatLayouts.findIndex(l => l.name === name);
        if(existingIdx >= 0) {
            state.seatLayouts[existingIdx] = layout;
        } else {
            state.seatLayouts.push(layout);
        }
        
        saveToStorage();
        renderLayoutOptions();
        renderLayoutsList();
        alert("座席表を保存しました");
    }

    function resetSeatForm() {
        document.getElementById('seat-layout-name').value = "";
        document.getElementById('seat-student-names').value = "";
        updateSeatPreview();
    }

    function renderLayoutsList() {
        const container = document.getElementById('saved-layouts-list');
        container.innerHTML = state.seatLayouts.map(l => `
            <div class="flex justify-between items-center bg-white border p-3 rounded-xl shadow-sm">
                <span class="text-sm font-bold text-green-800">${l.name}</span>
                <div class="flex gap-2">
                    <button class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded" onclick="editLayout('${l.id}')">編集</button>
                    <button class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded" onclick="deleteLayout('${l.id}')">削除</button>
                </div>
            </div>
        `).join('');
    }

    function editLayout(id) {
        const l = state.seatLayouts.find(x => x.id === id);
        if(!l) return;
        document.getElementById('seat-layout-name').value = l.name;
        document.getElementById('seat-cols').value = l.cols;
        document.getElementById('seat-rows').value = l.rows;
        document.getElementById('seat-total-count').value = l.studentCount;
        document.getElementById('seat-student-names').value = l.names.join('\n');
        updateSeatPreview();
        window.scrollTo(0,0);
    }

    function deleteLayout(id) {
        if(!confirm("削除しますか？")) return;
        state.seatLayouts = state.seatLayouts.filter(l => l.id !== id);
        saveToStorage();
        renderLayoutsList();
        renderLayoutOptions();
    }

    // --- PLAN MANAGEMENT ---
    function savePlan() {
        const criteria = document.getElementById('raw-criteria').value;
        const observationHtml = document.getElementById('observation-list').innerHTML;
        const month = document.getElementById('plan-month').value;
        const day = document.getElementById('plan-day').value;
        const periodId = document.getElementById('plan-period').value;
        const layoutId = document.getElementById('plan-layout').value;

        if (!criteria || !layoutId) return alert("評価基準とクラス（座席表）を設定してください");

        const plan = {
            id: Date.now(),
            criteria,
            observationHtml,
            month: parseInt(month),
            day: parseInt(day),
            periodId: parseInt(periodId),
            layoutId: layoutId
        };

        state.plans.push(plan);
        saveToStorage();
        alert("授業計画を保存しました。ホーム画面から開始できます。");
        navigate('home');
    }

    function deletePlan(id) {
        if(!confirm("この計画を削除しますか？（記録は残ります）")) return;
        state.plans = state.plans.filter(p => p.id !== id);
        saveToStorage();
        renderPlansList();
        renderHome();
    }

    // --- DASHBOARD RENDER ---
    function renderHome() {
        const todayContainer = document.getElementById('today-plans');
        const futureContainer = document.getElementById('future-plans');
        const now = new Date();
        const tMonth = now.getMonth() + 1;
        const tDay = now.getDate();

        const todayPlans = state.plans.filter(p => p.month === tMonth && p.day === tDay);
        const futurePlans = state.plans.filter(p => (p.month > tMonth) || (p.month === tMonth && p.day > tDay))
                                     .sort((a,b) => (a.month*100+a.day) - (b.month*100+b.day));

        const renderItem = (p) => {
            const period = state.periodSettings.find(s => s.id === p.periodId);
            const layout = state.seatLayouts.find(l => l.id === p.layoutId);
            return `
                <div class="card bg-white hover:border-green-300 border-2 border-transparent transition-all cursor-pointer" onclick="startEvaluation(${p.id})">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold">${period?.label || '時限設定なし'}</span>
                                <span class="text-xs text-gray-400 font-bold">${p.month}月${p.day}日</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800">${layout?.name || 'クラス不明'}</h3>
                            <p class="text-sm text-gray-500 line-clamp-1 mt-1">${p.criteria}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-full text-green-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                    </div>
                </div>
            `;
        };

        todayContainer.innerHTML = todayPlans.length ? todayPlans.map(renderItem).join('') : '<div class="text-center p-8 bg-white/50 rounded-2xl border-2 border-dashed border-gray-200 text-gray-400 font-bold">本日の授業は登録されていません</div>';
        futureContainer.innerHTML = futurePlans.length ? futurePlans.map(renderItem).join('') : '<p class="text-gray-400 text-sm">予定はありません</p>';
    }

    function renderPlansList() {
        const container = document.getElementById('plans-list-container');
        const tabContainer = document.getElementById('class-tabs');
        
        const classNames = [...new Set(state.seatLayouts.map(l => l.name))];
        tabContainer.innerHTML = `<button class="btn btn-outline text-xs" onclick="filterPlansByClass('all')">すべて表示</button>` + 
            classNames.map(cn => `<button class="btn btn-outline text-xs" onclick="filterPlansByClass('${cn}')">${cn}</button>`).join('');

        filterPlansByClass('all');
    }

    function filterPlansByClass(className) {
        const container = document.getElementById('plans-list-container');
        let filtered = state.plans;
        if(className !== 'all') {
            const layoutIds = state.seatLayouts.filter(l => l.name === className).map(l => l.id);
            filtered = state.plans.filter(p => layoutIds.includes(p.layoutId));
        }

        container.innerHTML = filtered.sort((a,b) => (b.month*100+b.day) - (a.month*100+a.day)).map(p => {
            const period = state.periodSettings.find(s => s.id === p.periodId);
            const layout = state.seatLayouts.find(l => l.id === p.layoutId);
            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] font-black text-green-300 uppercase">${p.month}/${p.day}</span>
                            <span class="text-[10px] font-bold text-gray-400">${period?.label}</span>
                        </div>
                        <p class="font-bold text-lg">${layout?.name || '削除済クラス'}</p>
                        <p class="text-xs text-gray-500">${p.criteria.substring(0,30)}...</p>
                    </div>
                    <button class="text-red-300 hover:text-red-500 p-2" onclick="deletePlan(${p.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    // --- EVALUATION MODE ---
    let currentPlan = null;
    function startEvaluation(planId) {
        currentPlan = state.plans.find(p => p.id === planId);
        if(!currentPlan) return;

        const layout = state.seatLayouts.find(l => l.id === currentPlan.layoutId);
        if(!layout) return alert("座席表データが削除されています");

        document.getElementById('eval-header').innerText = layout.name;
        document.getElementById('eval-sub-header').innerText = `${currentPlan.month}月${currentPlan.day}日・${state.periodSettings.find(s=>s.id==currentPlan.periodId)?.label}`;
        
        // 箇条書きを横並びのチップに変換して表示
        const points = currentPlan.observationHtml.match(/<li>(.*?)<\/li>/g)?.map(m => m.replace(/<\/?li>/g, '')) || [];
        document.getElementById('eval-points-display').innerHTML = points.map(p => `
            <div class="flex items-center justify-center gap-2 px-6 py-2 bg-white rounded-full border-2 border-green-100 shadow-sm">
                <span class="text-green-400">●</span> ${p}
            </div>
        `).join('');
        
        renderEvaluationGrid(layout);
        navigate('evaluate');
    }

    function renderEvaluationGrid(layout) {
        const container = document.getElementById('eval-seat-grid');
        container.innerHTML = '';
        const grid = document.createElement('div');
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = `repeat(${layout.cols}, 105px)`;
        grid.style.gap = '20px';

        for (let i = 0; i < layout.rows * layout.cols; i++) {
            const name = layout.names[i];
            const seat = document.createElement('div');
            seat.className = `seat ${!name ? 'empty' : ''} shadow-md`;
            if(name) {
                const pCount = state.evaluations.filter(e => e.planId === currentPlan.id && e.studentName === name && e.type === 'positive').length;
                const nCount = state.evaluations.filter(e => e.planId === currentPlan.id && e.studentName === name && e.type === 'negative').length;
                
                seat.innerHTML = `
                    <span class="font-bold text-lg">${name}</span>
                    <div class="flex gap-1 mt-1">
                        ${pCount > 0 ? `<span class="bg-green-400 text-white text-[9px] px-1 rounded-full">+${pCount}</span>` : ''}
                        ${nCount > 0 ? `<span class="bg-red-400 text-white text-[9px] px-1 rounded-full">-${nCount}</span>` : ''}
                    </div>
                `;
                seat.onclick = () => openActionModal(name);
            } else {
                seat.innerHTML = `<span class="text-gray-200">席</span>`;
            }
            grid.appendChild(seat);
        }
        container.appendChild(grid);
    }

    function openActionModal(studentName) {
        document.getElementById('modal-student-name').innerText = studentName;
        const posContainer = document.getElementById('modal-pos-actions');
        const negContainer = document.getElementById('modal-neg-actions');

        posContainer.innerHTML = state.actions.positive.map(act => `
            <button class="text-sm p-4 bg-green-50 text-green-700 rounded-2xl border-2 border-green-100 hover:bg-green-100 font-bold text-left flex justify-between items-center" onclick="recordEvaluation('${studentName}', '${act}', 'positive')">
                ${act} <span class="text-green-300">＋</span>
            </button>
        `).join('');

        negContainer.innerHTML = state.actions.negative.map(act => `
            <button class="text-sm p-4 bg-red-50 text-red-700 rounded-2xl border-2 border-red-100 hover:bg-red-100 font-bold text-left flex justify-between items-center" onclick="recordEvaluation('${studentName}', '${act}', 'negative')">
                ${act} <span class="text-red-300">−</span>
            </button>
        `).join('');

        document.getElementById('action-modal').style.display = 'flex';
    }

    function recordEvaluation(studentName, action, type) {
        state.evaluations.push({
            planId: currentPlan.id,
            studentName,
            action,
            type,
            timestamp: new Date().toISOString()
        });
        saveToStorage();
        closeModal();
        renderEvaluationGrid(state.seatLayouts.find(l => l.id === currentPlan.layoutId));
    }

    function closeModal() {
        document.getElementById('action-modal').style.display = 'none';
    }

    // --- EXPORT LOGIC (CSV with Pseudo-Tabs) ---
    function exportEvaluationHistory() {
        if(state.evaluations.length === 0) return alert("記録データがありません");

        // クラス別にデータを分ける (CSV自体にはタブ機能はないため、ソートとセパレータで対応)
        const sortedEvaluations = [...state.evaluations].sort((a,b) => {
            const planA = state.plans.find(p => p.id === a.planId);
            const planB = state.plans.find(p => p.id === b.planId);
            return (planA?.layoutId || "").localeCompare(planB?.layoutId || "");
        });

        let csv = "\uFEFF【パステル・ティーチャー・ログ 評価記録】\n";
        csv += "日時,学年クラス,生徒名,行動内容,評価種別,元の評価基準\n";
        
        let lastLayoutId = "";
        sortedEvaluations.forEach(e => {
            const plan = state.plans.find(p => p.id === e.planId);
            const layout = state.seatLayouts.find(l => l.id === plan?.layoutId);
            
            // クラスが変わる際に空行を入れる（タブ分けの代わり）
            if (lastLayoutId && lastLayoutId !== plan?.layoutId) csv += "\n";
            lastLayoutId = plan?.layoutId;

            const date = new Date(e.timestamp).toLocaleString('ja-JP');
            csv += `${date},${layout?.name || '不明'},${e.studentName},${e.action},${e.type === 'positive' ? '良' : '要指導'},"${plan?.criteria.replace(/"/g, '""')}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", `TeacherLog_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- SETTINGS RENDERERS ---
    function renderPeriodSettings() {
        const container = document.getElementById('period-settings-list');
        const select = document.getElementById('plan-period');
        container.innerHTML = state.periodSettings.map((s, idx) => `
            <div class="flex gap-2 items-center bg-gray-50 p-3 rounded-xl">
                <input type="text" value="${s.label}" class="p-2 border rounded-lg text-sm w-32" onchange="updatePeriod(${idx}, 'label', this.value)">
                <div class="flex items-center gap-1">
                    <input type="time" value="${s.start}" class="p-2 border rounded-lg text-xs" onchange="updatePeriod(${idx}, 'start', this.value)">
                    <span class="text-gray-400">〜</span>
                    <input type="time" value="${s.end}" class="p-2 border rounded-lg text-xs" onchange="updatePeriod(${idx}, 'end', this.value)">
                </div>
                <button class="text-red-300 hover:text-red-500 ml-auto" onclick="deletePeriod(${idx})">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        `).join('');
        
        select.innerHTML = state.periodSettings.map(s => `<option value="${s.id}">${s.label} (${s.start}〜)</option>`).join('');
    }

    function updatePeriod(idx, key, val) {
        state.periodSettings[idx][key] = val;
        saveToStorage();
        renderPeriodSettings();
    }

    function addPeriodSetting() {
        const id = Date.now();
        state.periodSettings.push({ id, label: `${state.periodSettings.length + 1}時間目`, start: '00:00', end: '00:00' });
        saveToStorage();
        renderPeriodSettings();
    }

    function deletePeriod(idx) {
        state.periodSettings.splice(idx, 1);
        saveToStorage();
        renderPeriodSettings();
    }

    function renderActionSettings() {
        const pos = document.getElementById('positive-actions');
        const neg = document.getElementById('negative-actions');
        
        const genHtml = (list, type) => list.map((act, idx) => `
            <div class="flex gap-2">
                <input value="${act}" class="flex-1 p-2 border rounded-lg text-sm" onchange="state.actions.${type}[${idx}]=this.value;saveToStorage()">
                <button onclick="state.actions.${type}.splice(${idx},1);saveToStorage();renderActionSettings()" class="text-red-300 hover:text-red-500">×</button>
            </div>
        `).join('');

        pos.innerHTML = genHtml(state.actions.positive, 'positive');
        neg.innerHTML = genHtml(state.actions.negative, 'negative');
    }

    function addAction(type) {
        state.actions[type].push("新しい項目");
        saveToStorage();
        renderActionSettings();
    }

    function renderLayoutOptions() {
        const select = document.getElementById('plan-layout');
        select.innerHTML = '<option value="">クラスを選択してください</option>' + 
            state.seatLayouts.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
    }

    // START APP
    window.onload = loadFromStorage;

</script>

<style>
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-pop { animation: pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
</style>

</body>
</html>
