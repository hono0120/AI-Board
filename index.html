<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å“¡å‘ã‘æˆæ¥­è©•ä¾¡æ”¯æ´ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #4f46e5; }
        body { background-color: #f1f5f9; font-family: sans-serif; overflow-x: hidden; }
        .page { display: none; }
        .page.active { display: block; }
        .seat { aspect-ratio: 1 / 1; transition: all 0.2s; position: relative; }
        /* è©•ä¾¡ã•ã‚Œã¦ã‚‚è‰²ã¯ã¤ã‹ãªã„ï¼ˆæ ç·šã ã‘ã‚ãšã‹ã«å¤‰åŒ–ã•ã›ã‚‹ç¨‹åº¦ã€ã¾ãŸã¯å¤‰åŒ–ãªã—ï¼‰ */
        .seat.selected { border: 2px solid #6366f1; background-color: #f8fafc; }
        .log-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .loading-dots:after { content: '...'; animation: dots 1.5s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    </style>
</head>
<body class="pb-24">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 z-50 shadow-lg">
            <button onclick="showPage('dashboard')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <span class="text-xl">ğŸ </span><span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
            </button>
            <button onclick="showPage('schedule')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <span class="text-xl">ğŸ“…</span><span class="text-[10px] font-bold">äºˆå®šãƒ»åŸºæº–</span>
            </button>
            <button onclick="showPage('class-config')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <span class="text-xl">ğŸ‘¥</span><span class="text-[10px] font-bold">åº§å¸­ãƒ»åç°¿</span>
            </button>
            <button onclick="showPage('settings')" class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <span class="text-xl">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span>
            </button>
        </nav>

        <!-- Page: Dashboard -->
        <section id="page-dashboard" class="page active">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">ä»Šæ—¥ã®æˆæ¥­äºˆå®š</h1>
                <p id="current-time-display" class="text-xs font-medium text-indigo-600 bg-white px-3 py-1 rounded-full shadow-sm border border-indigo-100"></p>
            </div>
            <div id="dashboard-list" class="space-y-4"></div>
        </section>

        <!-- Page: Schedule & Criteria -->
        <section id="page-schedule" class="page">
            <h1 class="text-xl font-bold mb-4">æˆæ¥­äºˆå®šã¨è©•ä¾¡åŸºæº–</h1>
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="input-date" class="border p-2 rounded-lg text-sm">
                    <select id="input-period" class="border p-2 rounded-lg text-sm"></select>
                </div>
                <input type="text" id="input-class" placeholder="1å¹´Açµ„ æ•°å­¦" class="w-full border p-2 rounded-lg text-sm">
                <textarea id="input-criteria" rows="3" class="w-full border p-2 rounded-lg text-sm" placeholder="æ•™ç§‘æ›¸ã®è©•ä¾¡åŸºæº–ã‚’å…¥åŠ›..."></textarea>

                <div id="ai-section" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-indigo-700">ğŸ” AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ</span>
                        <button onclick="generateAIPoints()" class="bg-indigo-600 text-white text-[10px] px-3 py-1 rounded-full hover:bg-indigo-700">AIä½œæˆ</button>
                    </div>
                    <div id="ai-result-area" class="text-sm text-indigo-900 space-y-1">
                        <p class="text-gray-400 italic text-xs">åŸºæº–ã‚’å…¥åŠ›ã—ã¦AIä½œæˆã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                    </div>
                    <div id="keyword-area" class="mt-3 pt-3 border-t border-indigo-200 hidden">
                        <div id="keyword-chips" class="flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex gap-2">
                            <input type="text" id="custom-keyword" placeholder="è‡ªç”±å…¥åŠ›..." class="flex-1 text-xs border p-1 rounded">
                            <button onclick="generateAIPoints(true)" class="bg-white border border-indigo-300 text-indigo-600 text-[10px] px-2 py-1 rounded">å†ä½œæˆ</button>
                        </div>
                    </div>
                </div>
                <button onclick="saveSchedule()" id="save-btn" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold">ç™»éŒ²ã™ã‚‹</button>
            </div>
            <div id="all-schedule-list" class="mt-6 space-y-2"></div>
        </section>

        <!-- Page: Class Config (Seat Settings) -->
        <section id="page-class-config" class="page">
            <h1 class="text-xl font-bold mb-4">ã‚¯ãƒ©ã‚¹åç°¿ãƒ»åº§å¸­è¨­å®š</h1>
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç”Ÿå¾’åç°¿ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼‰</label>
                    <textarea id="student-list-input" rows="8" class="w-full border p-2 rounded-lg text-sm font-mono" placeholder="ç”Ÿå¾’A&#10;ç”Ÿå¾’B&#10;ç”Ÿå¾’C..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ¨ªã®åˆ—æ•°</label>
                        <input type="number" id="grid-cols" value="6" class="w-full border p-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç©ºå¸­ã‚’å«ã‚ã‚‹ç·å¸­æ•°</label>
                        <input type="number" id="total-seats" value="36" class="w-full border p-2 rounded-lg text-sm">
                    </div>
                </div>
                <button onclick="saveClassConfig()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">åº§å¸­è¨­å®šã‚’åæ˜ </button>
            </div>
            <p class="text-[10px] text-gray-400 mt-4 text-center">â€»åº§å¸­é…ç½®ã®å¾®èª¿æ•´ã¯ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã«å¯¾å¿œäºˆå®šã§ã™ã€‚</p>
        </section>

        <!-- Page: Seating Chart (Live) -->
        <section id="page-classroom" class="page">
            <div class="flex items-center gap-3 mb-4">
                <button onclick="showPage('dashboard')" class="bg-white p-2 rounded-lg border text-sm shadow-sm">â†</button>
                <div>
                    <h2 id="view-class-title" class="text-lg font-bold"></h2>
                    <p id="view-class-info" class="text-[10px] text-gray-500"></p>
                </div>
            </div>

            <div class="bg-amber-50 border border-amber-200 p-3 rounded-xl mb-4">
                <div id="view-ai-points" class="text-xs font-bold text-amber-900 grid gap-1"></div>
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <!-- Seating Grid -->
                <div class="flex-1 bg-gray-200 p-4 rounded-3xl border shadow-inner">
                    <div class="w-24 mx-auto bg-white/50 py-1 text-[10px] text-center font-bold text-gray-400 rounded mb-6 border border-dashed border-gray-400">é»’æ¿ / æ•™å“</div>
                    <div id="seating-grid" class="grid gap-2"></div>
                </div>

                <!-- Real-time Record List -->
                <div class="w-full md:w-64 bg-white p-4 rounded-2xl border shadow-sm self-start">
                    <h3 class="text-xs font-bold text-gray-400 mb-3 border-b pb-2 uppercase tracking-wider">ã“ã®æ™‚é–“ã®è©•ä¾¡è¨˜éŒ²</h3>
                    <div id="live-log-list" class="space-y-2 max-h-[400px] overflow-y-auto scroll-hide">
                        <!-- Logs will appear here -->
                    </div>
                    <div id="empty-log-msg" class="text-[10px] text-gray-300 text-center py-4 italic">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>
        </section>

        <!-- Page: Settings -->
        <section id="page-settings" class="page">
            <h1 class="text-xl font-bold mb-4">æ ¡æ™‚ãƒ»æ™‚é–“è¨­å®š</h1>
            <div id="time-config-list" class="bg-white p-4 rounded-2xl border shadow-sm space-y-4"></div>
        </section>
    </div>

    <!-- Modal: Evaluation -->
    <div id="eval-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center hidden">
        <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl m-4">
            <h3 id="modal-student-name" class="text-lg font-bold mb-4">ç”Ÿå¾’å</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2">ãƒã‚¸ãƒ†ã‚£ãƒ–</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="recordEval('æŒ™æ‰‹ãƒ»ç™ºè¨€')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ™‹ ç™ºè¨€</button>
                        <button onclick="recordEval('ä»–è€…ã¸æ•™ãˆã‚‹')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ¤ ç›¸äº’æŒ‡å°</button>
                        <button onclick="recordEval('è‰¯ã„è§£æ³•')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ’¡ è‰¯ã„è§£æ³•</button>
                        <button onclick="recordEval('é›†ä¸­')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ“– é›†ä¸­</button>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-400 mb-2">ãƒ•ã‚©ãƒ­ãƒ¼</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="recordEval('é¨’ãŒã—ã„')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ“¢ é¨’ãŒã—ã„</button>
                        <button onclick="recordEval('ä¸­æ–­è¡Œç‚º')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">âš ï¸ ä¸­æ–­</button>
                        <button onclick="recordEval('å±…çœ ã‚Š')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ˜´ å±…çœ ã‚Š</button>
                        <button onclick="recordEval('å¿˜ã‚Œç‰©')" class="bg-gray-50 text-gray-700 p-2 rounded-xl text-xs border border-gray-200 active:bg-indigo-100 transition">ğŸ’ å¿˜ã‚Œç‰©</button>
                    </div>
                </div>
            </div>
            <button onclick="closeModal()" class="w-full mt-6 py-2 text-gray-400 text-sm border-t">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-2 rounded-full shadow-lg text-xs opacity-0 transition-opacity z-[200]"></div>

    <script>
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'teacher-private-v3';

        // --- Data State ---
        let state = {
            schedules: JSON.parse(localStorage.getItem(`${appId}_schedules`)) || [],
            logs: JSON.parse(localStorage.getItem(`${appId}_logs`)) || [],
            classConfig: JSON.parse(localStorage.getItem(`${appId}_classConfig`)) || {
                students: ["ç”Ÿå¾’1", "ç”Ÿå¾’2", "ç”Ÿå¾’3", "ç”Ÿå¾’4", "ç”Ÿå¾’5", "ç”Ÿå¾’6"],
                cols: 6,
                total: 36
            },
            timeConfig: JSON.parse(localStorage.getItem(`${appId}_timeConfig`)) || [
                { id: 1, label: "1æ ¡æ™‚", start: "08:50", end: "09:40" },
                { id: 2, label: "2æ ¡æ™‚", start: "09:50", end: "10:40" },
                { id: 3, label: "3æ ¡æ™‚", start: "10:50", end: "11:40" },
                { id: 4, label: "4æ ¡æ™‚", start: "11:50", end: "12:40" },
                { id: 5, label: "5æ ¡æ™‚", start: "13:30", end: "14:20" },
                { id: 6, label: "6æ ¡æ™‚", start: "14:30", end: "15:20" }
            ],
            currentAiPoints: [],
            currentKeywords: [],
            selectedStudent: null,
            selectedClassId: null
        };

        // --- Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'schedule') renderScheduleList();
            if (pageId === 'settings') renderSettings();
            if (pageId === 'class-config') renderClassConfig();
        }

        // --- AI Extraction ---
        async function generateAIPoints(isRegen = false) {
            const criteria = document.getElementById('input-criteria').value;
            if (!criteria) return showToast("è©•ä¾¡åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const area = document.getElementById('ai-result-area');
            area.innerHTML = '<p class="loading-dots text-indigo-400 text-xs">AIãŒè¡Œå‹•ç›®å®‰ã‚’è€ƒæ¡ˆä¸­</p>';

            let prompt = `ä»¥ä¸‹ã®æ•™ç§‘æ›¸çš„ãªè©•ä¾¡åŸºæº–ã‹ã‚‰ã€æœºé–“æŒ‡å°ã§è¦³å¯Ÿã™ã¹ãå…·ä½“çš„ãªè¡Œå‹•ç›®å®‰ã‚’3ã¤è€ƒãˆã¦ãã ã•ã„ã€‚
            ãƒ»ã€Œãƒ»ã€œã—ã¦ã„ã‚‹ã€ã®å½¢å¼ã€‚1ã¤20æ–‡å­—ä»¥å†…ã€‚
            ãƒ»è§£èª¬ã¯ä¸è¦ã€çµæœã®3è¡Œã®ã¿ã€‚
            è©•ä¾¡åŸºæº–: ${criteria}`;

            if (isRegen) {
                const custom = document.getElementById('custom-keyword').value;
                const chips = Array.from(document.querySelectorAll('.keyword-chip.active')).map(c => c.innerText);
                prompt += `\nç‰¹ã«ã€Œ${chips.join(', ')} ${custom}ã€ã«é–¢é€£ã™ã‚‹è¡Œå‹•ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚`;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ãƒ»è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆãªã—";
                state.currentAiPoints = text.split('\n').filter(l => l.includes('ãƒ»')).slice(0, 3);
                
                area.innerHTML = state.currentAiPoints.map(p => `<div class="font-bold">âœ… ${p}</div>`).join('');
                document.getElementById('keyword-area').classList.remove('hidden');
                extractKeywords(criteria);
            } catch (e) {
                area.innerHTML = '<p class="text-red-400">é€šä¿¡ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        async function extractKeywords(text) {
            const prompt = `ä»¥ä¸‹ã®æ–‡ã‹ã‚‰æ•™è‚²ãƒ»æˆæ¥­ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’4ã¤ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§çŸ­ãæŠ½å‡ºã—ã¦: ${text}`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const kw = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                state.currentKeywords = kw.split(/[,ã€]/).map(k => k.trim()).filter(k => k);
                
                const chips = document.getElementById('keyword-chips');
                chips.innerHTML = state.currentKeywords.map(k => `
                    <button onclick="this.classList.toggle('active'); this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white');" 
                            class="keyword-chip border border-indigo-200 px-2 py-1 rounded-full text-[10px] text-indigo-500 transition-colors">${k}</button>
                `).join('');
            } catch (e) {}
        }

        // --- Schedule & Config Management ---
        function saveSchedule() {
            const entry = {
                id: document.getElementById('edit-id').value || Date.now(),
                date: document.getElementById('input-date').value,
                periodId: document.getElementById('input-period').value,
                className: document.getElementById('input-class').value,
                criteria: document.getElementById('input-criteria').value,
                aiPoints: state.currentAiPoints
            };
            if (!entry.date || !entry.className) return showToast("æ—¥ä»˜ã¨ã‚¯ãƒ©ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const index = state.schedules.findIndex(s => s.id == entry.id);
            if (index > -1) state.schedules[index] = entry;
            else state.schedules.push(entry);

            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            resetForm();
            showPage('dashboard');
            showToast("ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function resetForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('input-class').value = '';
            document.getElementById('input-criteria').value = '';
            document.getElementById('ai-result-area').innerHTML = '<p class="text-gray-400 italic text-xs">åŸºæº–ã‚’å…¥åŠ›ã—ã¦AIä½œæˆã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
            document.getElementById('save-btn').innerText = "ç™»éŒ²ã™ã‚‹";
            state.currentAiPoints = [];
        }

        function saveClassConfig() {
            const raw = document.getElementById('student-list-input').value;
            const cols = parseInt(document.getElementById('grid-cols').value) || 6;
            const total = parseInt(document.getElementById('total-seats').value) || 36;
            
            state.classConfig = {
                students: raw.split('\n').map(s => s.trim()).filter(s => s),
                cols: cols,
                total: total
            };
            localStorage.setItem(`${appId}_classConfig`, JSON.stringify(state.classConfig));
            showToast("åº§å¸­ãƒ»åç°¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function renderClassConfig() {
            document.getElementById('student-list-input').value = state.classConfig.students.join('\n');
            document.getElementById('grid-cols').value = state.classConfig.cols;
            document.getElementById('total-seats').value = state.classConfig.total;
        }

        // --- Dashboard & Live View ---
        function renderDashboard() {
            const list = document.getElementById('dashboard-list');
            list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            const filtered = state.schedules.filter(s => s.date === today).sort((a,b) => a.periodId - b.periodId);

            if (filtered.length === 0) {
                list.innerHTML = '<div class="bg-white p-10 rounded-2xl border text-center text-gray-400 text-sm">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            }

            filtered.forEach(s => {
                const config = state.timeConfig.find(p => p.id == s.periodId);
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl shadow-sm border border-transparent hover:border-indigo-300 transition-all cursor-pointer";
                card.onclick = () => openClassroom(s);
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded">${config?.label || 'ä¸æ˜'}</span>
                        <span class="text-[10px] text-gray-400">${config?.start} ~ ${config?.end}</span>
                    </div>
                    <div class="font-bold text-gray-800">${s.className}</div>
                    <div class="text-[10px] text-gray-400 mt-2 truncate">${s.aiPoints.join(' / ')}</div>
                `;
                list.appendChild(card);
            });
            document.getElementById('current-time-display').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function openClassroom(s) {
            state.selectedClassId = s.id;
            const config = state.timeConfig.find(p => p.id == s.periodId);
            document.getElementById('view-class-title').innerText = s.className;
            document.getElementById('view-class-info').innerText = `${s.date} ${config?.label} (${config?.start}~${config?.end})`;
            
            const pointsArea = document.getElementById('view-ai-points');
            pointsArea.innerHTML = s.aiPoints.map(p => `<div>âœ… ${p}</div>`).join('') || "ãƒ»è¡Œå‹•ç›®å®‰ã¯æœªè¨­å®šã§ã™";

            renderSeatingGrid();
            renderLiveLogs();
            showPage('classroom');
        }

        function renderSeatingGrid() {
            const grid = document.getElementById('seating-grid');
            const { cols, total, students } = state.classConfig;
            grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            grid.innerHTML = '';

            for (let i = 0; i < total; i++) {
                const name = students[i] || "";
                const seat = document.createElement('div');
                // ç”Ÿå¾’ãŒã„ã‚Œã°ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã€‚ã„ãªã‘ã‚Œã°ç©ºå¸­è¡¨ç¤º
                if (name) {
                    seat.className = "seat bg-white border border-gray-300 rounded-lg flex flex-col items-center justify-center p-1 cursor-pointer shadow-sm";
                    seat.innerHTML = `<span class="text-[10px] font-bold text-gray-700 break-all text-center">${name}</span>`;
                    seat.onclick = () => openEvalModal(i, name);
                } else {
                    seat.className = "seat bg-gray-100 border border-dashed border-gray-300 rounded-lg";
                }
                grid.appendChild(seat);
            }
        }

        function openEvalModal(idx, name) {
            state.selectedStudent = { idx, name };
            document.getElementById('modal-student-name').innerText = name;
            document.getElementById('eval-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('eval-modal').classList.add('hidden');
        }

        function recordEval(action) {
            const entry = {
                id: Date.now(),
                classId: state.selectedClassId,
                studentIdx: state.selectedStudent.idx,
                studentName: state.selectedStudent.name,
                action: action,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            };
            state.logs.push(entry);
            localStorage.setItem(`${appId}_logs`, JSON.stringify(state.logs));
            
            closeModal();
            renderLiveLogs();
            showToast(`${state.selectedStudent.name}ã®è©•ä¾¡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
        }

        function renderLiveLogs() {
            const list = document.getElementById('live-log-list');
            const empty = document.getElementById('empty-log-msg');
            const currentLogs = state.logs.filter(l => l.classId == state.selectedClassId).sort((a,b) => b.id - a.id);
            
            if (currentLogs.length > 0) {
                empty.classList.add('hidden');
                list.innerHTML = currentLogs.map(l => `
                    <div class="log-enter bg-indigo-50 p-2 rounded-lg border border-indigo-100 flex justify-between items-center group">
                        <div class="flex-1">
                            <div class="text-[10px] font-bold text-gray-400">${l.time}</div>
                            <div class="text-xs text-indigo-900 font-bold">${l.studentName}</div>
                            <div class="text-[10px] text-indigo-700">${l.action}</div>
                        </div>
                        <button onclick="deleteLog(${l.id})" class="text-red-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition">âœ•</button>
                    </div>
                `).join('');
            } else {
                empty.classList.remove('hidden');
                list.innerHTML = '';
            }
        }

        function deleteLog(id) {
            state.logs = state.logs.filter(l => l.id != id);
            localStorage.setItem(`${appId}_logs`, JSON.stringify(state.logs));
            renderLiveLogs();
        }

        // --- Settings & Utils ---
        function renderSettings() {
            const list = document.getElementById('time-config-list');
            list.innerHTML = state.timeConfig.map(p => `
                <div class="flex items-center gap-2 border-b pb-2 last:border-none">
                    <span class="text-xs font-bold w-12 text-gray-400">${p.label}</span>
                    <input type="time" value="${p.start}" onchange="updateTime(${p.id}, 'start', this.value)" class="text-xs border p-1 rounded">
                    <span class="text-gray-300">~</span>
                    <input type="time" value="${p.end}" onchange="updateTime(${p.id}, 'end', this.value)" class="text-xs border p-1 rounded">
                </div>
            `).join('');
        }

        function updateTime(id, key, val) {
            state.timeConfig = state.timeConfig.map(p => p.id == id ? {...p, [key]: val} : p);
            localStorage.setItem(`${appId}_timeConfig`, JSON.stringify(state.timeConfig));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('opacity-100');
            setTimeout(() => t.classList.remove('opacity-100'), 2000);
        }

        function renderScheduleList() {
            const list = document.getElementById('all-schedule-list');
            list.innerHTML = state.schedules.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold">${s.date} - ${state.timeConfig.find(p => p.id == s.periodId)?.label}</div>
                        <div class="text-sm font-bold text-gray-700">${s.className}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSchedule(${s.id})" class="text-indigo-600 text-[10px] font-bold bg-indigo-50 px-2 py-1 rounded">ç·¨é›†</button>
                        <button onclick="deleteSchedule(${s.id})" class="text-red-400 text-[10px] font-bold px-2 py-1 rounded">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
            
            const periodSel = document.getElementById('input-period');
            if (periodSel.options.length === 0) {
                state.timeConfig.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.innerText = p.label;
                    periodSel.appendChild(opt);
                });
            }
        }

        function editSchedule(id) {
            const s = state.schedules.find(item => item.id == id);
            document.getElementById('edit-id').value = s.id;
            document.getElementById('input-date').value = s.date;
            document.getElementById('input-period').value = s.periodId;
            document.getElementById('input-class').value = s.className;
            document.getElementById('input-criteria').value = s.criteria;
            state.currentAiPoints = s.aiPoints;
            document.getElementById('ai-result-area').innerHTML = s.aiPoints.map(p => `<div class="font-bold">âœ… ${p}</div>`).join('');
            document.getElementById('save-btn').innerText = "æ›´æ–°ã™ã‚‹";
            window.scrollTo(0, 0);
        }

        function deleteSchedule(id) {
            if (!confirm("ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            state.schedules = state.schedules.filter(s => s.id != id);
            localStorage.setItem(`${appId}_schedules`, JSON.stringify(state.schedules));
            renderScheduleList();
            renderDashboard();
        }

        window.onload = () => renderDashboard();
    </script>
</body>
</html>
