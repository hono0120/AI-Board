<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæ¥­è©•ä¾¡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ | Teacher Support Pro</title>
    <style>
        :root {
            --primary: #e8f5e9;
            --accent: #81c784;
            --dark-green: #2e7d32;
            --bg: #f9fbf9;
            --white: #ffffff;
            --good: #c8e6c9;
            --bad: #ffccbc;
            --gray: #f0f0f0;
            --selected: #4caf50;
        }

        body {
            font-family: 'Helvetica Neue', Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0; padding: 0;
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--accent);
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0; z-index: 1001;
        }

        .current-time {
            font-size: 0.9rem;
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 15px;
        }

        main {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            width: 95%;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        h2, h3 { color: var(--dark-green); margin-top: 0; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9rem; color: #666; }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 2px solid var(--primary);
            border-radius: 10px; font-size: 1rem; box-sizing: border-box;
            background: white;
        }

        .btn {
            background-color: var(--accent);
            color: white; border: none; padding: 12px 20px;
            border-radius: 25px; cursor: pointer;
            font-weight: bold; font-size: 1rem;
            transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px;
        }

        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn:hover:not(:disabled) { filter: brightness(0.9); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--dark-green); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }

        .tabs {
            display: flex; gap: 10px; overflow-x: auto;
            margin-bottom: 20px; padding-bottom: 5px;
        }
        .tab {
            padding: 8px 16px; background: var(--white);
            border: 2px solid var(--primary); border-radius: 20px;
            cursor: pointer; white-space: nowrap; font-size: 0.9rem;
        }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        .seating-grid { display: grid; gap: 8px; margin-top: 15px; }
        .seat {
            aspect-ratio: 1.2 / 1; border: 1px solid var(--primary);
            border-radius: 6px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: white; cursor: pointer; font-size: 0.75rem; text-align: center;
            padding: 4px; overflow: hidden;
            position: relative;
            transition: background 0.2s;
        }
        .seat span { font-size: 0.6rem; color: #888; margin-top: 2px; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: var(--white); display: flex;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item {
            cursor: pointer; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 0.7rem; color: #888; flex: 1;
        }
        .nav-item.active { color: var(--dark-green); font-weight: bold; }

        .ai-container { background: #f0fdf4; border: 2px solid var(--accent); border-radius: 15px; padding: 20px; margin: 15px 0; }
        .keyword-tag { display: inline-block; background: var(--white); border: 1px solid var(--accent); padding: 5px 12px; border-radius: 15px; margin: 4px; font-size: 0.8rem; cursor: pointer; }
        .keyword-tag.selected { background: var(--accent); color: white; }

        .hidden { display: none !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 25px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: #333; }
    </style>
</head>
<body>

<header>
    <div id="header-title">ãƒ›ãƒ¼ãƒ </div>
    <div class="current-time" id="digital-clock">00:00:00</div>
</header>

<main>
    <!-- View: Home -->
    <div id="view-home" class="page-view">
        <div class="card">
            <h2>æœ¬æ—¥ã®æˆæ¥­äºˆå®š</h2>
            <div id="home-today-date" style="margin-bottom: 12px; color: var(--dark-green); font-weight: bold;"></div>
            <div id="today-schedule-list"></div>
        </div>
        <div class="card">
            <h2>æ˜æ—¥ä»¥é™ã®äºˆå®š</h2>
            <div id="future-schedule-list"></div>
        </div>
    </div>

    <!-- View: List -->
    <div id="view-list" class="page-view hidden">
        <div class="tabs" id="list-class-tabs"></div>
        <div class="card">
            <h2 id="list-title">ã™ã¹ã¦ã®æˆæ¥­è¨ˆç”»</h2>
            <div id="all-plans-list"></div>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="prepareNewPlan()">ï¼‹ æ–°è¦æˆæ¥­è¨ˆç”»ã‚’ä½œæˆ</button>
        </div>
    </div>

    <!-- View: Plan Edit -->
    <div id="view-plan" class="page-view hidden">
        <div class="card">
            <h2 id="plan-form-title">æˆæ¥­ã®ç™»éŒ²ãƒ»ç·¨é›†</h2>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;"><label>æ—¥ä»˜</label><input type="date" id="plan-date"></div>
                <div style="flex: 1;"><label>æ ¡æ™‚</label><select id="plan-period"></select></div>
            </div>
            <label>ã‚¯ãƒ©ã‚¹é¸æŠ</label>
            <select id="plan-class-select"></select>

            <label>è©•ä¾¡åŸºæº–ï¼ˆæ•™ç§‘æ›¸ã®ç›®æ¨™ãªã©ï¼‰</label>
            <textarea id="raw-criteria" placeholder="æ•™ç§‘æ›¸ã®ç›®æ¨™ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            <button class="btn" id="ai-gen-btn" onclick="processAI()">AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆ</button>

            <div id="ai-section" class="ai-container hidden">
                <h3>AIæŠ½å‡ºãƒã‚¤ãƒ³ãƒˆ</h3>
                <div id="ai-output" style="font-weight: bold; margin-bottom: 10px; white-space: pre-wrap;"></div>
                <div id="ai-keywords"></div>
                <label>è¿½åŠ è¦æœ›</label>
                <input type="text" id="teacher-plus" placeholder="ã‚‚ã£ã¨å…·ä½“çš„ã«ã€ãªã©">
                <button class="btn btn-outline" style="width: 100%;" onclick="processAI(true)">AIã§å†æ§‹æˆã™ã‚‹</button>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" style="flex: 2;" onclick="savePlan()">ä¿å­˜</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="switchView('list')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- View: Class Management -->
    <div id="view-seating-list" class="page-view hidden">
        <div class="card">
            <h2>ã‚¯ãƒ©ã‚¹ãƒ»åº§å¸­è¡¨ç®¡ç†</h2>
            <div id="saved-classes-list"></div>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="prepareNewClass()">ï¼‹ æ–°è¦ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ</button>
        </div>
    </div>

    <!-- View: Class Edit -->
    <div id="view-class-edit" class="page-view hidden">
        <div class="card">
            <h2 id="class-edit-title">ã‚¯ãƒ©ã‚¹ã®ç™»éŒ²ãƒ»ç·¨é›†</h2>
            <label>ã‚¯ãƒ©ã‚¹å</label>
            <input type="text" id="edit-class-name" placeholder="ä¾‹: ä¸­1A">
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;"><label>è¡Œï¼ˆç¸¦ï¼‰</label><input type="number" id="edit-class-rows" value="6"></div>
                <div style="flex: 1;"><label>åˆ—ï¼ˆæ¨ªï¼‰</label><input type="number" id="edit-class-cols" value="6"></div>
            </div>
            <label>ç”Ÿå¾’åï¼ˆã‚«ãƒ³ãƒã¾ãŸã¯æ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
            <textarea id="edit-class-students" rows="8" placeholder="ç”°ä¸­, ä½è—¤, éˆ´æœ¨..."></textarea>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" style="flex: 2;" onclick="saveClass()">ä¿å­˜</button>
                <button class="btn btn-outline" style="flex: 1;" onclick="switchView('seating-list')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- View: Settings -->
    <div id="view-settings" class="page-view hidden">
        <div class="card">
            <h2>æ ¡æ™‚ãƒ»è©•ä¾¡è¨­å®š</h2>
            <h3>æ ¡æ™‚è¨­å®š</h3>
            <div id="period-editor"></div>
            <button class="btn btn-outline" onclick="addEntry('periods')">ï¼‹ è¿½åŠ </button>
            <h3 style="margin-top:20px">è©•ä¾¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div id="action-editor"></div>
            <button class="btn btn-outline" onclick="addEntry('actions')">ï¼‹ è¿½åŠ </button>
        </div>
    </div>

    <!-- View: Run (Lesson Active) -->
    <div id="view-lesson-run" class="page-view hidden">
        <div class="card" id="run-header-info"></div>
        <div id="run-grid" class="seating-grid"></div>
        <button class="btn btn-outline" style="margin-top: 20px;" onclick="switchView('home')">çµ‚äº†ã—ã¦æˆ»ã‚‹</button>
    </div>
</main>

<nav class="bottom-nav">
    <div class="nav-item" onclick="switchView('home')"><span>ğŸ </span><span>ãƒ›ãƒ¼ãƒ </span></div>
    <div class="nav-item" onclick="switchView('list')"><span>ğŸ“</span><span>æˆæ¥­è¨ˆç”»</span></div>
    <div class="nav-item" onclick="switchView('seating-list')"><span>ğŸª‘</span><span>åº§å¸­è¡¨</span></div>
    <div class="nav-item" onclick="switchView('settings')"><span>âš™ï¸</span><span>è¨­å®š</span></div>
</nav>

<div id="eval-modal-overlay" class="modal-overlay">
    <div class="modal">
        <h2 id="eval-st-name"></h2>
        <div id="eval-target" style="padding: 10px; background: var(--primary); border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;"></div>
        <div class="action-grid" id="eval-btns"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // --- API Configuration ---
    // ã“ã“ã«APIã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å…¥åŠ›ã‚’ä¸è¦ã«ã—ã¾ã™ã€‚
    const apiKey = ""; 

    let appState = {
        periods: [{id:1, name:"1é™", start:"08:50"}, {id:2, name:"2é™", start:"09:50"}, {id:3, name:"3é™", start:"10:50"}],
        classes: [{id:"c1", name:"ä¸­1A", rows:6, cols:6, students: ["ç”°ä¸­", "ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ä¼Šè—¤", "æ¸¡è¾º"]}],
        plans: [],
        actions: [{id:1, text:"ç™ºè¨€", type:"good"}, {id:2, text:"æ•™ãˆåˆã„", type:"good"}, {id:3, text:"é›†ä¸­æ¬ å¦‚", type:"bad"}],
        evaluations: [],
        editingPlanId: null,
        editingClassId: null,
        selectedKeywords: [],
        activeListTab: "ã™ã¹ã¦"
    };

    // --- Core Logic ---
    function load() {
        const d = localStorage.getItem('teacher_pro_v6');
        if(d) appState = JSON.parse(d);
        updateClock();
        setInterval(updateClock, 1000);
        switchView('home');
    }

    function save() { localStorage.setItem('teacher_pro_v6', JSON.stringify(appState)); }

    function updateClock() {
        const now = new Date();
        const el = document.getElementById('digital-clock');
        if(el) el.innerText = now.toLocaleTimeString('ja-JP');
    }

    function switchView(id) {
        document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
        const target = document.getElementById(`view-${id}`);
        if(target) target.classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navMap = {home:0, list:1, 'seating-list':2, settings:3};
        if(navMap[id] !== undefined) document.querySelectorAll('.nav-item')[navMap[id]].classList.add('active');

        if(id === 'home') renderHome();
        if(id === 'list') renderPlanTabs();
        if(id === 'plan') renderPlanForm();
        if(id === 'seating-list') renderClassesList();
        if(id === 'settings') renderSettings();
    }

    // --- AI Core Logic with Retry Mechanism ---
    async function fetchGeminiAI(payload, retries = 5, delay = 1000) {
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 403 || response.status === 401) {
                        throw new Error("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã€ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚");
                    }
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return await response.json();
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(res => setTimeout(res, delay));
                delay *= 2; 
            }
        }
    }

    async function processAI(isRedo = false) {
        const raw = document.getElementById('raw-criteria').value;
        const plus = document.getElementById('teacher-plus').value;
        const btn = document.getElementById('ai-gen-btn');

        if (!apiKey) {
            console.warn("API Key is missing. AI features will not work.");
            alert("AIæ©Ÿèƒ½ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        if(!raw) return alert("æˆæ¥­ã®ç›®æ¨™ã‚„åŸºæº–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        
        btn.innerText = "AIãŒåˆ†æä¸­..."; 
        btn.disabled = true;

        const sysPrompt = "æ•™å“¡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å…¥åŠ›ã•ã‚ŒãŸè©•ä¾¡åŸºæº–ã‹ã‚‰ã€Œãƒ»ã€œã—ã¦ã„ã‚‹ã€å½¢å¼ã§å…·ä½“çš„ãªè¦³å¯Ÿé …ç›®ã‚’3ã¤æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚å„é …ç›®ã¯20æ–‡å­—ä»¥å†…ã§ç°¡æ½”ã«ã€‚";
        let userPrompt = `è©•ä¾¡åŸºæº–: ${raw}`;
        if(isRedo) userPrompt += `\næ³¨ç›®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${appState.selectedKeywords.join(',')}\nè¿½åŠ è¦æœ›: ${plus}`;

        const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: sysPrompt }] }
        };

        try {
            const data = await fetchGeminiAI(payload);
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                document.getElementById('ai-output').innerText = text.trim();
                if(!isRedo) {
                    const kws = [...new Set(raw.match(/[ä¸€-é¾ ]{2,}/g) || ["æ€è€ƒ","åˆ¤æ–­","è¡¨ç¾"])].slice(0,6);
                    document.getElementById('ai-keywords').innerHTML = kws.map(k => `
                        <span class="keyword-tag" onclick="this.classList.toggle('selected'); toggleKw('${k}')">${k}</span>
                    `).join('');
                }
                document.getElementById('ai-section').classList.remove('hidden');
            } else {
                throw new Error("Invalid response");
            }
        } catch(e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        } finally {
            btn.innerText = "AIè¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆè‡ªå‹•ç”Ÿæˆ"; 
            btn.disabled = false;
        }
    }

    function toggleKw(k) {
        if(appState.selectedKeywords.includes(k)) appState.selectedKeywords = appState.selectedKeywords.filter(x => x!==k);
        else appState.selectedKeywords.push(k);
    }

    // --- Plan Management ---
    function renderPlanForm() {
        const periodSelect = document.getElementById('plan-period');
        const classSelect = document.getElementById('plan-class-select');
        periodSelect.innerHTML = appState.periods.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        classSelect.innerHTML = appState.classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    function prepareNewPlan() {
        appState.editingPlanId = null;
        appState.selectedKeywords = [];
        document.getElementById('plan-form-title').innerText = "æ–°è¦æˆæ¥­è¨ˆç”»ã®ä½œæˆ";
        document.getElementById('plan-date').valueAsDate = new Date();
        document.getElementById('raw-criteria').value = "";
        document.getElementById('ai-output').innerText = "";
        document.getElementById('ai-section').classList.add('hidden');
        document.getElementById('teacher-plus').value = "";
        switchView('plan');
    }

    function savePlan() {
        const d = document.getElementById('plan-date').value;
        const p = document.getElementById('plan-period').value;
        const c = document.getElementById('plan-class-select').value;
        const ai = document.getElementById('ai-output').innerText;
        if(!d || !ai || !c) return alert("å¿…é ˆé …ç›®ï¼ˆæ—¥ä»˜ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»AIç”Ÿæˆçµæœï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
        const plan = { 
            id: appState.editingPlanId || Date.now(), 
            date: d, period: p, className: c, 
            raw: document.getElementById('raw-criteria').value,
            aiPoints: ai.split('\n').map(x => x.trim()).filter(x => x) 
        };
        if(appState.editingPlanId) appState.plans = appState.plans.map(x => x.id === plan.id ? plan : x);
        else appState.plans.push(plan);
        save(); switchView('list');
    }

    function renderPlanTabs() {
        const clsNames = ["ã™ã¹ã¦", ...new Set(appState.classes.map(c => c.name))];
        document.getElementById('list-class-tabs').innerHTML = clsNames.map(n => `
            <div class="tab ${appState.activeListTab === n ? 'active' : ''}" onclick="appState.activeListTab='${n}'; renderPlanTabs(); renderAllPlansList();">${n}</div>
        `).join('');
        renderAllPlansList();
    }

    function renderAllPlansList() {
        let filtered = appState.plans;
        if(appState.activeListTab !== "ã™ã¹ã¦") filtered = filtered.filter(p => p.className === appState.activeListTab);
        filtered.sort((a,b) => b.date.localeCompare(a.date));
        const list = document.getElementById('all-plans-list');
        if(filtered.length === 0) { list.innerHTML = "<p style='color:#999; text-align:center;'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>"; return; }
        list.innerHTML = filtered.map(p => `
            <div class="card" style="padding:15px; border-left:5px solid var(--accent); margin-bottom:10px">
                <div style="display:flex; justify-content:space-between; align-items: center;">
                    <div><b>${p.date} / ${p.period} / ${p.className}</b><div style="font-size:0.8rem; color:#666">${p.aiPoints.join(' / ')}</div></div>
                    <button class="btn-outline" onclick="editPlan(${p.id})">ç·¨é›†</button>
                </div>
            </div>`).join('');
    }

    function editPlan(id) {
        appState.editingPlanId = id;
        const p = appState.plans.find(x => x.id === id);
        if(!p) return;
        switchView('plan');
        document.getElementById('plan-form-title').innerText = "æˆæ¥­è¨ˆç”»ã®ä¿®æ­£";
        document.getElementById('plan-date').value = p.date;
        document.getElementById('plan-period').value = p.period;
        document.getElementById('plan-class-select').value = p.className;
        document.getElementById('raw-criteria').value = p.raw || "";
        document.getElementById('ai-output').innerText = p.aiPoints.join('\n');
        document.getElementById('ai-section').classList.remove('hidden');
    }

    // --- Class Management ---
    function renderClassesList() {
        const list = document.getElementById('saved-classes-list');
        if(appState.classes.length === 0) { list.innerHTML = "<p style='color:#999; text-align:center;'>ã‚¯ãƒ©ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>"; return; }
        list.innerHTML = appState.classes.map(c => `
            <div class="card" style="padding:15px; border-left:5px solid var(--accent); margin-bottom:10px">
                <div style="display:flex; justify-content:space-between; align-items: center;">
                    <div><b>${c.name}</b><div style="font-size:0.8rem; color:#666">${c.rows}è¡ŒÃ—${c.cols}åˆ— (${c.students.length}å)</div></div>
                    <button class="btn-outline" onclick="editClass('${c.id}')">ç·¨é›†</button>
                </div>
            </div>`).join('');
    }

    function prepareNewClass() {
        appState.editingClassId = null;
        document.getElementById('class-edit-title').innerText = "æ–°è¦ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ";
        document.getElementById('edit-class-name').value = "";
        document.getElementById('edit-class-rows').value = 6;
        document.getElementById('edit-class-cols').value = 6;
        document.getElementById('edit-class-students').value = "";
        switchView('class-edit');
    }

    function editClass(id) {
        appState.editingClassId = id;
        const c = appState.classes.find(x => x.id === id);
        if(!c) return;
        document.getElementById('edit-class-name').value = c.name;
        document.getElementById('edit-class-rows').value = c.rows;
        document.getElementById('edit-class-cols').value = c.cols;
        document.getElementById('edit-class-students').value = c.students.join(', ');
        switchView('class-edit');
    }

    function saveClass() {
        const name = document.getElementById('edit-class-name').value;
        const rows = parseInt(document.getElementById('edit-class-rows').value);
        const cols = parseInt(document.getElementById('edit-class-cols').value);
        const stRaw = document.getElementById('edit-class-students').value;
        if(!name || !stRaw) return alert("ã‚¯ãƒ©ã‚¹åã¨ç”Ÿå¾’åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        const students = stRaw.split(/,|\n/).map(s => s.trim()).filter(s => s);
        const cls = { id: appState.editingClassId || "c_" + Date.now(), name, rows, cols, students };
        if(appState.editingClassId) appState.classes = appState.classes.map(x => x.id === cls.id ? cls : x);
        else appState.classes.push(cls);
        save(); switchView('seating-list');
    }

    // --- Home Display ---
    function renderHome() {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        document.getElementById('home-today-date').innerText = now.toLocaleDateString('ja-JP', {month:'long', day:'numeric', weekday:'long'});
        const todayPlans = appState.plans.filter(p => p.date === today).sort((a,b) => a.period.localeCompare(b.period));
        const futurePlans = appState.plans.filter(p => p.date > today).sort((a,b) => a.date.localeCompare(b.date));

        const drawList = (ps, elId) => {
            const el = document.getElementById(elId);
            if(ps.length === 0) return el.innerHTML = "<p style='color:#999; text-align:center;'>æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            el.innerHTML = ps.map(p => `
                <div class="card" style="border-left:8px solid var(--accent); padding:15px; cursor:pointer;" onclick="startRun(${p.id})">
                    <b>${p.period} : ${p.className}</b>
                    <div style="font-size:0.8rem; margin-top:5px; color:#777;">${p.aiPoints[0] || 'è©•ä¾¡é …ç›®æœªç”Ÿæˆ'}</div>
                </div>`).join('');
        };
        drawList(todayPlans, 'today-schedule-list');
        drawList(futurePlans, 'future-schedule-list');
    }

    // --- Lesson Run ---
    let currentRun = null;
    function startRun(id) {
        currentRun = appState.plans.find(x => x.id === id);
        const cls = appState.classes.find(c => c.name === currentRun.className);
        if(!cls) return alert("ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        switchView('lesson-run');
        document.getElementById('run-header-info').innerHTML = `<h3>${currentRun.className} - ${currentRun.period}</h3><div style="font-size:0.85rem; color:#444;">${currentRun.aiPoints.join(' / ')}</div>`;
        const grid = document.getElementById('run-grid');
        grid.style.gridTemplateColumns = `repeat(${cls.cols}, 1fr)`;
        grid.innerHTML = Array.from({length: cls.rows * cls.cols}).map((_, i) => {
            const name = cls.students[i] || '';
            return `<div class="seat" onclick="openEval(${i+1}, '${name || 'ç•ªå·'+(i+1)}')"><b>${name || '-'}</b><span>${i+1}</span></div>`;
        }).join('');
    }

    let targetIdx = null;
    function openEval(idx, name) {
        targetIdx = idx;
        document.getElementById('eval-st-name').innerText = name;
        document.getElementById('eval-target').innerText = "é‡ç‚¹: " + (currentRun.aiPoints[0] || "æœªè¨­å®š");
        document.getElementById('eval-btns').innerHTML = appState.actions.map(a => `<button class="action-btn" style="background:${a.type==='good'?'var(--good)':'var(--bad)'}" onclick="record('${a.text}')">${a.text}</button>`).join('');
        document.getElementById('eval-modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('eval-modal-overlay').style.display = 'none'; }
    function record(act) {
        appState.evaluations.push({ time: new Date().toLocaleString(), d: currentRun.date, p: currentRun.period, c: currentRun.className, s: targetIdx, a: act });
        save(); closeModal();
    }

    // --- Settings UI ---
    function renderSettings() {
        const pe = document.getElementById('period-editor');
        pe.innerHTML = appState.periods.map((p,i) => `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input type="text" value="${p.name}" onchange="appState.periods[${i}].name=this.value;save()">
                <button onclick="appState.periods.splice(${i},1);save();renderSettings()">âœ•</button>
            </div>`).join('');
        const ae = document.getElementById('action-editor');
        ae.innerHTML = appState.actions.map((a,i) => `
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input type="text" value="${a.text}" onchange="appState.actions[${i}].text=this.value;save()">
                <button onclick="appState.actions.splice(${i},1);save();renderSettings()">âœ•</button>
            </div>`).join('');
    }
    
    function addEntry(k) {
        if(k==='periods') appState.periods.push({id:Date.now(), name:"æ–°æ ¡æ™‚", start:"00:00"});
        if(k==='actions') appState.actions.push({id:Date.now(), text:"æ–°è¡Œå‹•", type:"good"});
        save(); renderSettings();
    }

    window.onload = load;
</script>
</body>
</html>
